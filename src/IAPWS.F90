!   Copyright 2016 University of Auckland.

!   This file is part of Waiwera.

!   Waiwera is free software: you can redistribute it and/or modify
!   it under the terms of the GNU Lesser General Public License as published by
!   the Free Software Foundation, either version 3 of the License, or
!   (at your option) any later version.

!   Waiwera is distributed in the hope that it will be useful,
!   but WITHOUT ANY WARRANTY; without even the implied warranty of
!   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!   GNU Lesser General Public License for more details.

!   You should have received a copy of the GNU Lesser General Public License
!   along with Waiwera.  If not, see <http://www.gnu.org/licenses/>.

module IAPWS_module

  !! IAPWS-97 industrial thermodynamic formulation, as described by:
  !!
  !! Wagner, W., Cooper, J.R., Dittman, A., Kijima, J., Kretzschmar, H.-J., Kruse, A., Mares, R., 
  !! Oguchi, K., Sato, H., Stocker, I., Sifner, O., Takaishi, Y., Tanishita, I., Trubenbach, J. and
  !! Willkommen, Th., 1997.  **The IAPWS Industrial Formulation 1997 for the Thermodynamic Properties of
  !! Water and Steam.**  *Trans. ASME* 150(122), 150-182.
  !!
  !! The viscosity function is described by:
  !! IAPWS, 2008.  **Release on the IAPWS Formulation 2008 for the Viscosity of Ordinary Water Substance.**

#include <petsc/finclude/petscsys.h>

  use petscsys
  use kinds_module
  use powertable_module
  use thermodynamics_module
  use utils_module, only: polynomial, newton1d

  implicit none
  private

!------------------------------------------------------------------------
! Constants
!------------------------------------------------------------------------

  type(critical_point_type), parameter, public :: critical = &
       critical_point_type(647.096_dp, 373.946_dp, 22.064e6_dp, 322.0_dp)

  PetscInt, parameter, public :: WIDOM_DELTA_BDY_LIQUID = 1, &
       WIDOM_DELTA_BDY_VAPOUR = 2

!------------------------------------------------------------------------
! Saturation curve type
!------------------------------------------------------------------------

  type, public, extends(saturation_type) :: IAPWS_saturation_type
     !! IAPWS-97 saturation curve calculations.
     private
     PetscReal :: pstar = 1.0e6_dp
     PetscReal :: n(10) = [ &
           0.11670521452767e4_dp, -0.72421316703206e6_dp, -0.17073846940092e2_dp,  &
           0.12020824702470e5_dp, -0.32325550322333e7_dp,  0.14915108613530e2_dp,  &
          -0.48232657361591e4_dp,  0.40511340542057e6_dp, -0.23855557567849_dp, &
           0.65017534844798e3_dp]
     contains
       private
       procedure, public :: temperature => saturation_temperature
       procedure, public :: pressure => saturation_pressure
  end type IAPWS_saturation_type

!------------------------------------------------------------------------
! Viscosity type
!------------------------------------------------------------------------

  type :: IAPWS_viscosity_type
     !! IAPWS viscosity type.
     private
     PetscReal :: mustar = 1.0e-6_dp
     PetscReal :: h0(0:3) = [ &
          1.67752_dp, 2.20462_dp, 0.6366564_dp, -0.241605_dp]
     PetscReal :: h1(21) = [ &
           5.20094e-1_dp,  8.50895e-2_dp, -1.08374_dp,    -2.89555e-1_dp,  2.22531e-1_dp,  &
           9.99115e-1_dp,  1.88797_dp,     1.26613_dp,     1.20573e-1_dp, -2.81378e-1_dp,  &
          -9.06851e-1_dp, -7.72479e-1_dp, -4.89837e-1_dp, -2.57040e-1_dp,  1.61913e-1_dp, &
           2.57399e-1_dp, -3.25372e-2_dp,  6.98452e-2_dp,  8.72102e-3_dp, -4.35673e-3_dp,  &
          -5.93264e-4_dp]
     PetscInt :: I(21) = [0,1,2,3,0,1,2,3,5,0,1,2,3,4,0,1,0,3,4,3,5]
     PetscInt :: J(21) = [0,0,0,0,1,1,1,1,1,2,2,2,2,2,3,3,4,4,5,6,6]
     PetscInt :: K(4)  = [0,1,2,3]
     type(powertable_type) :: pi, pj, pk
   contains
     private
     procedure, public :: init => viscosity_init
     procedure, public :: destroy => viscosity_destroy
  end type IAPWS_viscosity_type

!------------------------------------------------------------------------
! Thermodynamic sub-region type (for region 3 backwards equations)
!------------------------------------------------------------------------

  type, public :: IAPWS_subregion3_type
     !! Thermodynamic sub-region type for region 3 backwards equations.
     PetscReal :: nustar, pstar, tstar
     PetscReal :: a, b, c, d, e
     PetscBool :: exp_form
     PetscInt, allocatable :: I(:), J(:)
     PetscReal, allocatable :: n(:)
     type(powertable_type) :: pi, pj
   contains
     private
     procedure, public :: init => subregion3_init
     procedure, public :: destroy => subregion3_destroy
     procedure, public :: specific_volume => subregion3_specific_volume
  end type IAPWS_subregion3_type

!------------------------------------------------------------------------
! IAPWS region type
!------------------------------------------------------------------------

  type, public, extends(region_type) :: IAPWS_region_type
     !! IAPWS-97 region type- implements viscosity method, which is
     !! common to all regions, and pressure method (used to invert
     !! properties in region 1 and 2)
     private
     type(IAPWS_viscosity_type), public :: visc
   contains
     private
     procedure, public :: init => region_init
     procedure, public :: destroy => region_destroy
     procedure, public :: properties => region_properties
     procedure, public :: viscosity => region_viscosity
     procedure, public :: pressure => region_pressure
  end type IAPWS_region_type

!------------------------------------------------------------------------
  ! Region 1 (liquid water) type
!------------------------------------------------------------------------

  type, public, extends(IAPWS_region_type) :: IAPWS_region1_type
     !! IAPWS-97 region 1 (liquid water) type.
     private
     PetscReal :: pstar = 16.53e6_dp, tstar = 1386._dp
     PetscReal :: n(34) = [ &                
           0.14632971213167_dp,     -0.84548187169114_dp,    -0.37563603672040e1_dp,   &
           0.33855169168385e1_dp,   -0.95791963387872_dp,     0.15772038513228_dp,     &
          -0.16616417199501e-1_dp,   0.81214629983568e-3_dp,  0.28319080123804e-3_dp,  &
          -0.60706301565874e-3_dp,  -0.18990068218419e-1_dp, -0.32529748770505e-1_dp,  &
          -0.21841717175414e-1_dp,  -0.52838357969930e-4_dp, -0.47184321073267e-3_dp,  &
          -0.30001780793026e-3_dp,   0.47661393906987e-4_dp, -0.44141845330846e-5_dp,  &
          -0.72694996297594e-15_dp, -0.31679644845054e-4_dp, -0.28270797985312e-5_dp,  &
          -0.85205128120103e-9_dp,  -0.22425281908000e-5_dp, -0.65171222895601e-6_dp,  &
          -0.14341729937924e-12_dp, -0.40516996860117e-6_dp, -0.12734301741641e-8_dp,  &
          -0.17424871230634e-9_dp,  -0.68762131295531e-18_dp, 0.14478307828521e-19_dp, &
           0.26335781662795e-22_dp, -0.11947622640071e-22_dp, 0.18228094581404e-23_dp, &
          -0.93537087292458e-25_dp]
     PetscInt :: I(34) = [ &           
           0,  0,  0,  0,  0,  0, 0, 0, 1, 1, 1, 1, 1, 1, &
           2,  2,  2,  2,  2,  3, 3, 3, 4, 4, 4, 5, 8, 8, &
          21, 23, 29, 30, 31, 32]
     PetscInt :: J(34) = [ &            
           -2, -1,   0,   1,   2,   3,   4,   5, -9, -7, -1,  0,  1, &
            3, -3,   0,   1,   3,  17,  -4,   0,  6, -5, -2, 10, -8,  &
          -11, -6, -29, -31, -38, -39, -40, -41]
     PetscReal :: nI(34), nJ(34)
     PetscInt :: I_1(34), J_1(34)
     type(powertable_type) :: pi, pj
     PetscReal :: max_temperature
   contains
     private
     procedure, public :: init => region1_init
     procedure, public :: destroy => region1_destroy
     procedure, public :: properties => region1_properties
     procedure, public :: pressure => region1_pressure
  end type IAPWS_region1_type

!------------------------------------------------------------------------
  ! Region 2 (steam) type
!------------------------------------------------------------------------

  type, public, extends(IAPWS_region_type) :: IAPWS_region2_type
     !! IAPWS-97 region 2 (steam) type.
     private
     PetscReal :: pstar = 1.0e6_dp, tstar = 540.0_dp
     PetscReal :: n0(9) = [ &
          -0.96927686500217e1_dp,   0.10086655968018e2_dp, -0.56087911283020e-2_dp, &
           0.71452738081455e-1_dp, -0.40710498223928_dp,    0.14240819171444e1_dp,  &
          -0.43839511319450e1_dp,  -0.28408632460772_dp,    0.21268463753307e-1_dp]
     PetscReal :: n(43) = [ &
          -0.17731742473213e-2_dp,  -0.17834862292358e-1_dp,  -0.45996013696365e-1_dp, &
          -0.57581259083432e-1_dp,  -0.50325278727930e-1_dp,  -0.33032641670203e-4_dp, &
          -0.18948987516315e-3_dp,  -0.39392777243355e-2_dp,  -0.43797295650573e-1_dp, &
          -0.26674547914087e-4_dp,   0.20481737692309e-7_dp,   0.43870667284435e-6_dp, &
          -0.32277677238570e-4_dp,  -0.15033924542148e-2_dp,  -0.40668253562649e-1_dp, &
          -0.78847309559367e-9_dp,   0.12790717852285e-7_dp,   0.48225372718507e-6_dp, &
           0.22922076337661e-5_dp,  -0.16714766451061e-10_dp, -0.21171472321355e-2_dp, &
          -0.23895741934104e2_dp,   -0.59059564324270e-17_dp, -0.12621808899101e-5_dp, &
          -0.38946842435739e-1_dp,   0.11256211360459e-10_dp, -0.82311340897998e1_dp,  &
           0.19809712802088e-7_dp,   0.10406965210174e-18_dp, -0.10234747095929e-12_dp, &
           -0.10018179379511e-8_dp,  -0.80882908646985e-10_dp,     0.10693031879409_dp, &
           -0.33662250574171_dp,      0.89185845355421e-24_dp,  0.30629316876232e-12_dp, &
           -0.42002467698208e-5_dp,  -0.59056029685639e-25_dp,  0.37826947613457e-5_dp, &
           -0.12768608934681e-14_dp,  0.73087610595061e-28_dp,  0.55414715350778e-16_dp, &
           -0.94369707241210e-6_dp ]
     PetscInt :: J0(9) = [0, 1, -5, -4, -3, -2, -1, 2, 3]
     PetscInt :: I(43) = [ &
           1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  3,  3,  3,  3,  3, &
           4,  4,  4,  5,  6,  6,  6,  7,  7,  7,  8,  8,  9, 10, 10, &
          10, 16, 16, 18, 20, 20, 20, 21, 22, 23, 24, 24, 24]
     PetscInt :: J(43) = [ &
           0,  1,  2,  3,  6,  1,  2,  4,  7, 36,  0,  1,  3, 6,&
          35,  1,  2,  3,  7,  3, 16, 35,  0, 11, 25,  8, 36,  &
          13,  4, 10, 14, 29, 50, 57, 20, 35, 48, 21, 53,      &
          39, 26, 40, 58]
     PetscReal :: n0J0(9), nI(43), nJ(43)
     PetscInt :: J0_1(9), I_1(43), J_1(43)
     type(powertable_type) :: pj0, pi, pj
   contains
     private
     procedure, public :: init => region2_init
     procedure, public :: destroy => region2_destroy
     procedure, public :: properties => region2_properties
     procedure, public :: pressure => region2_pressure
  end type IAPWS_region2_type

!------------------------------------------------------------------------
  ! Region 3 (supercritical) type
!------------------------------------------------------------------------

  type, public, extends(IAPWS_region_type) :: IAPWS_region3_type
     !! IAPWS-97 region 3 (supercritical) type.
     private
     PetscReal :: dstar, tstar
     PetscReal :: n(40) = [ &
          0.10658070028513e1_dp, -0.15732845290239e2_dp,   0.20944396974307e2_dp,  &
          -0.76867707878716e1_dp,  0.26185947787954e1_dp,  -0.28080781148620e1_dp, &
          0.12053369696517e1_dp,  -0.84566812812502e-2_dp, -0.12654315477714e1_dp, &
          -0.11524407806681e1_dp,   0.88521043984318_dp,    -0.64207765181607_dp,  &
           0.38493460186671_dp,   -0.85214708824206_dp,     0.48972281541877e1_dp, &
           -0.30502617256965e1_dp, 0.39420536879154e-1_dp,   0.12558408424308_dp,   &
           -0.27999329698710_dp,     0.13899799569460e1_dp, -0.20189915023570e1_dp, &
           -0.82147637173963e-2_dp, -0.47596035734923_dp,     0.43984074473500e-1_dp, &
           -0.44476435428739_dp,    0.90572070719733_dp,     0.70522450087967_dp, &
           0.10770512626332_dp,     -0.32913623258954_dp,   -0.50871062041158_dp, &
           -0.22175400873096e-1_dp,  0.94260751665092e-1_dp, 0.16436278447961_dp, &
           -0.13503372241348e-1_dp, -0.14834345352472e-1_dp,  0.57922953628084e-3_dp, &
           0.32308904703711e-2_dp, 0.80964802996215e-4_dp, -0.16557679795037e-3_dp, &
           -0.44923899061815e-4_dp]
     PetscInt :: I(40) = [ &
          0,  0,  0,   0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, &
          3,  3,  3,   3, 3, 4, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 8, 9, &
          9 , 10, 10, 11]
     PetscInt :: J(40) = [ &
           0, 0,  1, 2,  7, 10, 12, 23, 2,  6, 15, 17,  0, 2, 6,  7, 22,  &
          26, 0,  2, 4, 16, 26,  0,  2, 4, 26,  1,  3, 26, 0, 2, 26,  2, &
          26, 2, 26, 0,  1, 26]
     PetscReal :: nI(40), nJ(40)
     PetscInt :: I_1(40), I_2(40), J_1(40)
     type(powertable_type) :: pi, pi2, pj

     ! Sub-regions for backwards equations:
     PetscInt :: num_subregions = 26
     type(IAPWS_subregion3_type) :: subregion(26)

     ! Sub-region boundaries
     PetscReal :: pstar = 1.e6_dp
     PetscReal :: psat_643, psat_623
     PetscReal :: p3cd = 1.900881189173929e7_dp
     PetscReal, public :: subregion_bdy_n_ab(3) = [0.154793642129415e4_dp, &
          -0.187661219490113e3_dp, 0.213144632222113e2_dp]
     PetscReal, public :: subregion_bdy_ninv_ab(3) = [0._dp, &
          -0.191887498864292e4_dp, 0.918419702359447e3_dp]
     PetscReal, public :: subregion_bdy_n_cd(4) = [0.585276966696349e3_dp, &
          0.278233532206915e1_dp, -0.127283549295878e-1_dp, 0.159090746562729e-3_dp]
     PetscReal, public :: subregion_bdy_n_gh(5) = [-0.249284240900418e5_dp, &
          0.428143584791546e4_dp, -0.269029173140130e3_dp, &
          0.751608051114157e1_dp, -0.787105249910383e-1_dp]
     PetscReal, public :: subregion_bdy_n_ij(5) = [0.584814781649163e3_dp, &
          -0.616179320924617_dp, 0.260763050899562_dp, -0.587071076864459e-2_dp, &
          0.515308185433082e-4_dp]
     PetscReal, public :: subregion_bdy_n_jk(5) = [0.617229772068439e3_dp, &
          -0.770600270141675e1_dp, 0.697072596851896_dp, -0.157391839848015e-1_dp, &
          0.137897492684194e-3_dp]
     PetscReal, public :: subregion_bdy_n_mn(4) = [0.535339483742384e3_dp, &
          0.761978122720128e1_dp, -0.158365725441648_dp, 0.192871054508108e-2_dp]
     PetscReal, public :: subregion_bdy_n_op(3) = [0.969461372400213e3_dp, &
          -0.332500170441278e3_dp, 0.642859598466067e2_dp]
     PetscReal, public :: subregion_bdy_ninv_op(3) = [0._dp, &
          0.773845935768222e3_dp, -0.152313732937084e4_dp]
     PetscReal, public :: subregion_bdy_n_qu(4) = [0.565603648239126e3_dp, &
          0.529062258221222e1_dp, -0.102020639611016_dp, 0.122240301070145e-2_dp]
     PetscReal, public :: subregion_bdy_n_rx(4) = [0.584561202520006e3_dp, &
          -0.102961025163669e1_dp, 0.243293362700452_dp, -0.294905044740799e-2_dp]
     PetscReal, public :: subregion_bdy_n_uv(4) = [0.528199646263062e3_dp, &
          0.890579602135307e1_dp, -0.222814134903755_dp, 0.286791682263697e-2_dp]
     PetscReal, public :: subregion_bdy_n_wx(3) = [0.728052609145380e1_dp, &
          0.973505869861952e2_dp, 0.147370491183191e2_dp]
     PetscReal, public :: subregion_bdy_ninv_wx(3) = [0._dp, &
          0.329196213998375e3_dp, 0.873371668682417e3_dp]

     ! Sub-region constants
     PetscReal :: subregion_nustar(26) = [ &
          0.0024_dp, 0.0041_dp, 0.0022_dp, 0.0029_dp, 0.0032_dp, &
          0.0064_dp, 0.0027_dp, 0.0032_dp, 0.0041_dp, 0.0054_dp, &
          0.0077_dp, 0.0026_dp, 0.0028_dp, 0.0031_dp, 0.0034_dp, &
          0.0041_dp, 0.0022_dp, 0.0054_dp, 0.0022_dp, 0.0088_dp, &
          0.0026_dp, 0.0031_dp, 0.0039_dp, 0.0049_dp, 0.0031_dp, 0.0038_dp]
     PetscReal :: subregion_pstar(26) = [ &
          100.e6_dp, 100.e6_dp, 40.e6_dp,  40.e6_dp,  40.e6_dp, &
          40.e6_dp,  25.e6_dp,  25.e6_dp,  25.e6_dp,  25.e6_dp, &
          25.e6_dp,  24.e6_dp,  23.e6_dp,  23.e6_dp,  23.e6_dp, &
          23.e6_dp,  23.e6_dp,  23.e6_dp,  21.e6_dp,  20.e6_dp, &
          23.e6_dp,  23.e6_dp,  23.e6_dp,  23.e6_dp,  22.e6_dp,  22.e6_dp]
     PetscReal :: subregion_tstar(26) = [ &
          760._dp, 860._dp, 690._dp, 690._dp, 710._dp, &
          730._dp, 660._dp, 660._dp, 660._dp, 670._dp, &
          680._dp, 650._dp, 650._dp, 650._dp, 650._dp, &
          650._dp, 650._dp, 650._dp, 640._dp, 650._dp, &
          650._dp, 650._dp, 650._dp, 650._dp, 650._dp, 650._dp]
     PetscReal :: subregion_a(26) = [ &
          0.085_dp, 0.280_dp, 0.259_dp, 0.559_dp, 0.587_dp, &
          0.587_dp, 0.872_dp, 0.898_dp, 0.910_dp, 0.875_dp, &
          0.802_dp, 0.908_dp, 1.000_dp, 0.976_dp, 0.974_dp, &
          0.972_dp, 0.848_dp, 0.874_dp, 0.886_dp, 0.803_dp, &
          0.902_dp, 0.960_dp, 0.959_dp, 0.910_dp, 0.996_dp, 0.993_dp]
     PetscReal :: subregion_b(26) = [ &
          0.817_dp, 0.779_dp, 0.903_dp, 0.939_dp, 0.918_dp, &
          0.891_dp, 0.971_dp, 0.983_dp, 0.984_dp, 0.964_dp, &
          0.935_dp, 0.989_dp, 0.997_dp, 0.997_dp, 0.996_dp, &
          0.997_dp, 0.983_dp, 0.982_dp, 0.990_dp, 1.020_dp, &
          0.988_dp, 0.995_dp, 0.995_dp, 0.988_dp, 0.994_dp, 0.994_dp]
     PetscReal :: subregion_c(26) = [ &
          1._dp, 1._dp, 1._dp, 1._dp, 1._dp, &
          0.5_dp, 1._dp, 1._dp, 0.5_dp, 0.5_dp, &
          1._dp, 1._dp, 1._dp, 0._dp, 0.5_dp, &
          0.5_dp, 1._dp, 1._dp, 1._dp, 1._dp, &
          1._dp, 1._dp, 1._dp, 1._dp, 1._dp, 1._dp]
     PetscReal :: subregion_d(26) = [ &
          1._dp, 1._dp, 1._dp, 1._dp, 1._dp, &
          1._dp, 1._dp, 1._dp, 1._dp, 1._dp, &
          1._dp, 1._dp, 0.25_dp, 0._dp, 1._dp, &
          1._dp, 1._dp, 1._dp, 1._dp, 1._dp, &
          1._dp, 1._dp, 1._dp, 1._dp, 1._dp, 1._dp]
     PetscReal :: subregion_e(26) = [ &
          1._dp, 1._dp, 1._dp, 4._dp, 1._dp, &
          4._dp, 4._dp, 4._dp, 4._dp, 4._dp, &
          1._dp, 4._dp, 1._dp, 0._dp, 1._dp, &
          1._dp, 4._dp, 1._dp, 4._dp, 1._dp, &
          1._dp, 1._dp, 4._dp, 1._dp, 4._dp, 4._dp]
     PetscBool :: subregion_exp_form(26) = [ &
          PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, &
          PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, &
          PETSC_FALSE, PETSC_FALSE, PETSC_FALSE,  PETSC_TRUE, PETSC_FALSE, &
          PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, &
          PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE, PETSC_FALSE]
     PetscInt :: subregion_num_consts(26) = [ &
          30, 32, 35, 38, 29, 42, 38, 29, 42, 29, &
          34, 43, 40, 39, 24, 27, 24, 27, 29, 33, &
          38, 39, 35, 36, 20, 23]

     PetscInt :: subregion_I(43, 26) = reshape([ &
          -12, -12, -12, -10, -10, -10, -8, -8, -8, -6, & ! a
          -5, -5, -5, -4, -3, -3, -3, -3, -2, -2, &
          -2, -1, -1, -1, 0, 0, 1, 1, 2, 2, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -12, -12, -10, -10, -8, -6, -6, -6, -5, -5, & ! b
          -5, -4, -4, -4, -3, -3, -3, -3, -3, -2, &
          -2, -2, -1, -1, 0, 0, 1, 1, 2, 3, 4, 4, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -12, -12, -12, -10, -10, -10, -8, -8, -8, -6, & ! c
          -5, -5, -5, -4, -4, -3, -3, -2, -2, -2, &
          -1, -1, -1, 0, 0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 8, &
          0, 0, 0, 0, 0, 0, 0, 0, &
          -12, -12, -12, -12, -12, -12, -10, -10, -10, -10, & ! d
          -10, -10, -10, -8, -8, -8, -8, -6, -6, -5, &
          -5, -5, -5, -4, -4, -4, -3, -3, -2, -2, &
          -1, -1, -1, 0, 0, 1, 1, 3, &
          0, 0, 0, 0, 0, &
          -12, -12, -10, -10, -10, -10, -10, -8, -8, -8, & ! e
          -6, -5, -4, -4, -3, -3, -3, -2, -2, -2, &
          -2, -1, 0, 0, 1, 1, 1, 2, 2, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 1, 1, 1, 1, & ! f
          2, 2, 3, 3, 3, 4, 5, 5, 6, 7, &
          7, 10, 12, 12, 12, 14, 14, 14, 14, 14, &
          16, 16, 18, 18, 20, 20, 20, 22, 24, 24, 28, 32, &
          0, &
          -12, -12, -12, -12, -12, -12, -10, -10, -10, -8, & ! g
          -8, -8, -8, -6, -6, -5, -5, -4, -3, -2, &
          -2, -2, -2, -1, -1, -1, 0, 0, 0, 1, &
          1, 1, 3, 5, 6, 8, 10, 10, &
          0, 0, 0, 0, 0, &
          -12, -12, -10, -10, -10, -10, -10, -10, -8, -8, & ! h
          -8, -8, -8, -6, -6, -6, -5, -5, -5, -4, &
          -4, -3, -3, -2, -1, -1, 0, 1, 1, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 1, 1, 1, 1, 2, 3, 3, & ! i
          4, 4, 4, 5, 5, 5, 7, 7, 8, 8, &
          10, 12, 12, 12, 14, 14, 14, 14, 18, 18, &
          18, 18, 18, 20, 20, 22, 24, 24, 32, 32, 36, 36, &
          0, &
          0, 0, 0, 1, 1, 1, 2, 2, 3, 4, & ! j
          4, 5, 5, 5, 6, 10, 12, 12, 14, 14, &
          14, 16, 18, 20, 20, 24, 24, 28, 28, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -2, -2, -1, -1, 0, -0, 0, 0, 0, 0, & ! k
          0, 0, 0, 1, 1, 1, 1, 1, 2, 2, &
          2, 2, 2, 2, 5, 5, 5, 6, 6, 6, 6, 8, 10, 12, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -12, -12, -12, -12, -12, -10, -10, -8, -8, -8, & ! l
          -8, -8, -8, -8, -6, -5, -5, -4, -4, -3, &
          -3, -3, -3, -2, -2, -2, -1, -1, -1, 0, &
          0, 0, 0, 1, 1, 2, 4, 5, 5, 6, 10, 10, 14, &
          0, 3, 8, 20, 1, 3, 4, 5, 1, 6, & ! m
          2, 4, 14, 2, 5, 3, 0, 1, 1, 1, &
          28, 2, 16, 0, 5, 0, 3, 4, 12, 16, &
          1, 8, 14, 0, 2, 3, 4, 8, 14, 24, &
          0, 0, 0, &
          0, 3, 4, 6, 7, 10, 12, 14, 18, 0, & ! n
          3, 5, 6, 8, 12, 0, 3, 7, 12, 2, &
          3, 4, 2, 4, 7, 4, 3, 5, 6, 0, &
          0, 3, 1, 0, 1, 0, 1, 0, 1, &
          0, 0, 0, 0, &
          0, 0, 0, 2, 3, 4, 4, 4, 4, 4, & ! o
          5, 5, 6, 7, 8, 8, 8, 10, 10, 14, 14, 20, 20, 24, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 1, 2, 3, 3, 4, 6, & ! p
          7, 7, 8, 10, 12, 12, 12, 14, 14, 14, &
          16, 18, 20, 22, 24, 24, 36, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, &
          -12, -12, -10, -10, -10, -10, -8, -6, -5, -5, & ! q
          -4, -4, -3, -2, -2, -2, -2, -1, -1, -1, 0, 1, 1, 1, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -8, -8, -3, -3, -3, -3, -3, 0, 0, 0, & ! r
          0, 3, 3, 8, 8, 8, 8, 10, 10, 10, &
          10, 10, 10, 10, 10, 12, 14, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, &
          -12, -12, -10, -8, -6, -5, -5, -4, -4, -3, & ! s
          -3, -2, -1, -1, -1, 0, 0, 0, 0, 1, &
          1, 3, 3, 3, 4, 4, 4, 5, 14, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, &
          0, 0, 0, 0, 1, 1, 2, 2, 2, 3, & ! t
          3, 4, 4, 7, 7, 7, 7, 7, 10, 10, &
          10, 10, 10, 18, 20, 22, 22, 24, 28, 32, 32, 32, 36, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -12, -10, -10, -10, -8, -8, -8, -6, -6, -5, & ! u
          -5, -5, -3, -1, -1, -1, -1, 0, 0, 1, &
          2, 2, 3, 5, 5, 5, 6, 6, 8, 8, &
          10, 12, 12, 12, 14, 14, 14, 14, &
          0, 0, 0, 0, 0, &
          -10, -8, -6, -6, -6, -6, -6, -6, -5, -5, & ! v
          -5, -5, -5, -5, -4, -4, -4, -4, -3, -3, &
          -3, -2, -2, -1, -1, 0, 0, 0, 1, 1, &
          3, 4, 4, 4, 5, 8, 10, 12, 14, &
          0, 0, 0, 0, &
          -12, -12, -10, -10, -8, -8, -8, -6, -6, -6, & ! w
          -6, -5, -4, -4, -3, -3, -2, -2, -1, -1, &
          -1, 0, 0, 1, 2, 2, 3, 3, 5, 5, &
          5, 8, 8, 10, 10, &
          0, 0, 0, 0, 0, 0, 0, 0, &
          -8, -6, -5, -4, -4, -4, -3, -3, -1, 0, & ! x
          0, 0, 1, 1, 2, 3, 3, 3, 4, 5, &
          5, 5, 6, 8, 8, 8, 8, 10, 12, 12, &
          12, 12, 14, 14, 14, 14, &
          0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 1, 2, 2, 2, 2, 3, & ! y
          3, 3, 4, 4, 5, 5, 8, 8, 10, 12, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -8, -6, -5, -5, -4, -4, -4, -3, -3, -3, & ! z
          -2, -1, 0, 1, 2, 3, 3, 6, 6, 6, 6, 8, 8, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0], &
          [43,26])

     PetscInt :: subregion_J(43, 26) = reshape([ &
          5, 10, 12, 5, 10, 12, 5, 8, 10, 1, & ! a
          1, 5, 10, 8, 0, 1, 3, 6, 0, 2, &
          3, 0, 1, 2, 0, 1, 0, 2, 0, 2, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          10, 12, 8, 14, 8, 5, 6, 8, 5, 8, & ! b
          10, 2, 4, 5, 0, 1, 2, 3, 5, 0, &
          2, 5, 0, 2, 0, 1, 0, 2, 0, 2, 0, 1, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          6, 8, 10, 6, 8, 10, 5, 6, 7, 8, & ! c
          1, 4, 7, 2, 8, 0, 3, 0, 4, 5, &
          0, 1, 2, 0, 1, 2, 0, 2, 0, 1, &
          3, 7, 0, 7, 1, &
          0, 0, 0, 0, 0, 0, 0, 0, &
          4, 6, 7, 10, 12, 16, 0, 2, 4, 6, & ! d
          8, 10, 14, 3, 7, 8, 10, 6, 8, 1, &
          2, 5, 7, 0, 1, 7, 2, 4, 0, 1, &
          0, 1, 5, 0, 2, 0, 6, 0, &
          0, 0, 0, 0, 0, &
          14, 16, 3, 6, 10, 14, 16, 7, 8, 10, & ! e
          6, 6, 2, 4, 2, 6, 7, 0, 1, 3, &
          4, 0, 0, 1, 0, 4, 6, 0, 2, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -3, -2, -1, 0, 1, 2, -1, 1, 2, 3, & ! f
          0, 1, -5, -2, 0, -3, -8, 1, -6, -4, &
          1, -6, -10, -8, -4, -12, -10, -8, -6, -4, &
          -10, -8, -12, -10, -12, -10, -6, -12, -12, -4, -12, -12, &
          0, &
          7, 12, 14, 18, 22, 24, 14, 20, 24, 7, & ! g
          8, 10, 12, 8, 22, 7, 20, 22, 7, 3, &
          5, 14, 24, 2, 8, 18, 0, 1, 2, 0, &
          1, 3, 24, 22, 12, 3, 0, 6, &
          0, 0, 0, 0, 0, &
          8, 12, 4, 6, 8, 10, 14, 16, 0, 1, & ! h
          6, 7, 8, 4, 6, 8, 2, 3, 4, 2, &
          4, 1, 2, 0, 0, 2, 0, 0, 2, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 1, 10, -4, -2, -1, 0, 0, -5, 0, & ! i
          -3, -2, -1, -6, -1, 12, -4, -3, -6, 10, &
          -8, -12, -6, -4, -10, -8, -4, 5, -12, -10, &
          -8, -6, 2, -12, -10, -12, -12, -8, -10, -5, -10, -8, &
          0, &
          -1, 0, 1, -2, -1, 1, -1, 1, -2, -2, & ! j
          2, -3, -2, 0, 3, -6, -8, -3, -10, -8, &
          -5, -10, -12, -12, -10, -12, -6, -12, -5, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          10, 12, -5, 6, -12, -6, -2, -1, 0, 1, & ! k
          2, 3, 14, -3, -2, 0, 1, 2, -8, -6, &
          -3, -2, 0, 4, -12, -6, -3, -12, -10, -8, -5, -12, -12, -10, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
          14, 16, 18, 20, 22, 14, 24, 6, 10, 12, & ! l
          14, 18, 24, 36, 8, 4, 5, 7, 16, 1, &
          3, 18, 20, 2, 3, 10, 0, 1, 3, 0, &
          1, 2, 12, 0, 16, 1, 0, 0, 1, 14, 4, 12, 10, &
          0, 0, 0, &
          2, 5, 5, 5, 5, 6, 6, 7, 8, 8, & ! m
          10, 10, 12, 14, 14, 18, 20, 20, 22, 22, &
          24, 24, 28, 28, 28, 28, 28, 32, 32, 32, &
          36, 36, 36, 36, 36, 36, 36, &
          0, 0, 0, &
          -12, -12, -12, -12, -12, -12, -12, -12, -12, -10, & ! n
          -10, -10, -10, -10, -10, -8, -8, -8, -8, -6, &
          -6, -6, -5, -5, -5, -4, -3, -3, -3, -2, &
          -1, -1, 0, 1, 1, 2, 4, 5, 6, &
          0, 0, 0, 0, &
          -12, -4, -1, -1, -10, -12, -8, -5, -4, -1, & ! o
          -4, -3, -8, -12, -10, -8, -4, -12, -8, -12, &
          -8, -12, -10, -12, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          -1, 0, 1, 2, 1, -1, -3, 0, -2, -2, & ! p
          -5, -4, -2, -3, -12, -6, -5, -10, -8, -3, &
          -8, -8, -10, -10, -12, -8, -12, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          10, 12, 6, 7, 8, 10, 8, 6, 2, 5, & ! q
          3, 4, 3, 0, 1, 2, 4, 0, 1, 2, 0, 0, 1, 3, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          6, 14, -3, 3, 4, 5, 8, -1, 0, 1, & ! r
          5, -6, -2, -12, -10, -8, -5, -12, -10, -8, &
          -6, -5, -4, -3, -2, -12, -12, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          20, 24, 22, 14, 36, 8, 16, 6, 32, 3, & ! s
          8, 4, 1, 2, 3, 0, 1, 4, 28, 0, &
          32, 0, 1, 2, 3, 18, 24, 4, 24, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 1, 4, 12, 0, 10, 0, 6, 14, 3, & ! t
          8, 0, 10, 3, 4, 7, 20, 36, 10, 12, &
          14, 16, 22, 18, 32, 22, 36, 24, 28, 22, 32, 36, 36, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          14, 10, 12, 14, 10, 12, 14, 8, 12, 4, & ! u
          8, 12, 2, -1, 1, 12, 14, -3, 1, -2, &
          5, 10, -5, -4, 2, 3, -5, 2, -8, 8, &
          -4, -12, -4, 4, -12, -10, -6, 6, &
          0, 0, 0, 0, 0, &
          -8, -12, -12, -3, 5, 6, 8, 10, 1, 2, & ! v
          6, 8, 10, 14, -12, -10, -6, 10, -3, 10, &
          12, 2, 4, -2, 0, -2, 6, 10, -12, -10, &
          3, -6, 3, 10, 2, -12, -2, -3, 1, &
          0, 0, 0, 0, &
          8, 14, -1, 8, 6, 8, 14, -4, -3, 2, & ! w
          8, -10, -1, 3, -10, 3, 1, 2, -8, -4, &
          1, -12, 1, -1, -1, 2, -12, -5, -10, -8, &
          -6, -12, -10, -12, -8, &
          0, 0, 0, 0, 0, 0, 0, 0, &
          14, 10, 10, 1, 2, 14, -2, 12, 5, 0, & ! x
          4, 10, -10, -1, 6, -12, 0, 8, 3, -6, &
          -2, 1, 1, -6, -3, 1, 8, -8, -10, -8, &
          -5, -4, -12, -10, -8, -6, &
          0, 0, 0, 0, 0, 0, 0, &
          -3, 1, 5, 8, 8, -4, -1, 4, 5, -8, & ! y
          4, 8, -6, 6, -2, 1, -8, -2, -5, -8, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          3, 6, 6, 8, 5, 6, 8, -2, 5, 6, & ! z
          2, -6, 3, 1, 6, -6, -2, -6, -5, -4, &
          -1, -8, -4, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0], &
          [43,26])

     PetscReal :: subregion_n(43, 26) = reshape([ &
          1.10879558823853e-03_dp, 5.72616740810616e+02_dp, -7.67051948380852e+04_dp, &
          -2.53321069529674e-02_dp, 6.28008049345689e+03_dp, 2.34105654131876e+05_dp, &
          2.16867826045856e-01_dp, -1.56237904341963e+02_dp, -2.69893956176613e+04_dp, &
          -1.80407100085505e-04_dp, 1.16732227668261e-03_dp, 2.66987040856040e+01_dp, &
          2.82776617243286e+04_dp, -2.42431520029523e+03_dp, 4.35217323022733e-04_dp, &
          -1.22494831387441e-02_dp, 1.79357604019989e+00_dp, 4.42729521058314e+01_dp, &
          -5.93223489018342e-03_dp, 4.53186261685774e-01_dp, 1.35825703129140e+00_dp, &
          4.08748415856745e-02_dp, 4.74686397863312e-01_dp, 1.18646814997915e+00_dp, &
          5.46987265727549e-01_dp, 1.95266770452643e-01_dp, -5.02268790869663e-02_dp, &
          -3.69645308193377e-01_dp, 6.33828037528420e-03_dp, 7.97441793901017e-02_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, -8.27670470003621e-02_dp, 4.16887126010565e+01_dp, &
          4.83651982197059e-02_dp, -2.91032084950276e+04_dp, -1.11422582236948e+02_dp, &
          -2.02300083904014e-02_dp, 2.94002509338515e+02_dp, 1.40244997609658e+02_dp, &
          -3.44384158811459e+02_dp, 3.61182452612149e+02_dp, -1.40699677420738e+03_dp, &
          -2.02023902676481e-03_dp, 1.71346792457471e+02_dp, -4.25597804058632e+00_dp, &
          6.91346085000334e-06_dp, 1.51140509678925e-03_dp, -4.16375290166236e-02_dp, &
          -4.13754957011042e+01_dp, -5.06673295721637e+01_dp, -5.72212965569023e-04_dp, &
          6.08817368401785e+00_dp, 2.39600660256161e+01_dp, 1.22261479925384e-02_dp, &
          2.16356057692938e+00_dp, 3.98198903368642e-01_dp, -1.16892827834085e-01_dp, &
          -1.02845919373532e-01_dp, -4.92676637589284e-01_dp, 6.55540456406790e-02_dp, &
          -2.40462535078530e-01_dp, -2.69798180310075e-02_dp, 1.28369435967012e-01_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 3.11967788763030e+00_dp, &
          2.76713458847564e+04_dp, 3.22583103403269e+07_dp, -3.42416065095363e+02_dp, &
          -8.99732529907377e+05_dp, -7.93892049821251e+07_dp, 9.53193003217388e+01_dp, &
          2.29784742345072e+03_dp, 1.75336675322499e+05_dp, 7.91214365222792e+06_dp, &
          3.19933345844209e-05_dp, -6.59508863555767e+01_dp, -8.33426563212851e+05_dp, &
          6.45734680583292e-02_dp, -3.82031020570813e+06_dp, 4.06398848470079e-05_dp, &
          3.10327498492008e+01_dp, -8.92996718483724e-04_dp, 2.34604891591616e+02_dp, &
          3.77515668966951e+03_dp, 1.58646812591361e-02_dp, 7.07906336241843e-01_dp, &
          1.26016225146570e+01_dp, 7.36143655772152e-01_dp, 6.76544268999101e-01_dp, &
          -1.78100588189137e+01_dp, -1.56531975531713e-01_dp, 1.17707430048158e+01_dp, &
          8.40143653860447e-02_dp, -1.86442467471949e-01_dp, -4.40170203949645e+01_dp, &
          1.23290423502494e+06_dp, -2.40650039730845e-02_dp, -1.07077716660869e+06_dp, &
          4.38319858566475e-02_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          -4.52484847171645e-10_dp, 3.15210389538801e-05_dp, -2.14991352047545e-03_dp, &
          5.08058874808345e+02_dp, -1.27123036845932e+07_dp, 1.15371133120497e+12_dp, &
          -1.97805728776273e-16_dp, 2.41554806033972e-11_dp, -1.56481703640525e-06_dp, &
          2.77211346836625e-03_dp, -2.03578994462286e+01_dp, 1.44369489909053e+06_dp, &
          -4.11254217946539e+10_dp, 6.23449786243773e-06_dp, -2.21774281146038e+01_dp, &
          -6.89315087933158e+04_dp, -1.95419525060713e+07_dp, 3.16373510564015e+03_dp, &
          2.24040754426988e+06_dp, -4.36701347922356e-06_dp, -4.04213852833996e-04_dp, &
          -3.48153203414663e+02_dp, -3.85294213555289e+05_dp, 1.35203700099403e-07_dp, &
          1.34648383271089e-04_dp, 1.25031835351736e+05_dp, 9.68123678455841e-02_dp, &
          2.25660517512438e+02_dp, -1.90102435341872e-04_dp, -2.99628410819229e-02_dp, &
          5.00833915372121e-03_dp, 3.87842482998411e-01_dp, -1.38535367777182e+03_dp, &
          8.70745245971773e-01_dp, 1.71946252068742e+00_dp, -3.26650121426383e-02_dp, &
          4.98044171727877e+03_dp, 5.51478022765087e-03_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 7.15815808404721e+08_dp, -1.14328360753449e+11_dp, &
          3.76531002015720e-12_dp, -9.03983668691157e-05_dp, 6.65695908836252e+05_dp, &
          5.35364174960127e+09_dp, 7.94977402335603e+10_dp, 9.22230563421437e+01_dp, &
          -1.42586073991215e+05_dp, -1.11796381424162e+06_dp, 8.96121629640760e+03_dp, &
          -6.69989239070491e+03_dp, 4.51242538486834e-03_dp, -3.39731325977713e+01_dp, &
          -1.20523111552278e+00_dp, 4.75992667717124e+04_dp, -2.66627750390341e+05_dp, &
          -1.53314954386524e-04_dp, 3.05638404828265e-01_dp, 1.23654999499486e+02_dp, &
          -1.04390794213011e+03_dp, -1.57496516174308e-02_dp, 6.85331118940253e-01_dp, &
          1.78373462873903e+00_dp, -5.44674124878910e-01_dp, 2.04529931318843e+03_dp, &
          -2.28342359328752e+04_dp, 4.13197481515899e-01_dp, -3.41931835910405e+01_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, -2.51756547792325e-08_dp, &
          6.01307193668763e-06_dp, -1.00615977450049e-03_dp, 9.99969140252192e-01_dp, &
          2.14107759236486e+00_dp, -1.65175571959086e+01_dp, -1.41987303638727e-03_dp, &
          2.69251915156554e+00_dp, 3.49741815858722e+01_dp, -3.00208695771783e+01_dp, &
          -1.31546288252539e+00_dp, -8.39091277286169e+00_dp, 1.81545608337015e-10_dp, &
          -5.91099206478909e-04_dp, 1.52115067087106e+00_dp, 2.52956470663225e-05_dp, &
          1.00726265203786e-15_dp, -1.49774533860650e+00_dp, -7.93940970562969e-10_dp, &
          -1.50290891264717e-04_dp, 1.51205531275133e+00_dp, 4.70942606221652e-06_dp, &
          1.95049710391712e-13_dp, -9.11627886266077e-09_dp, 6.04374640201265e-04_dp, &
          -2.25132933900136e-16_dp, 6.10916973582981e-12_dp, -3.03063908043404e-07_dp, &
          -1.37796070798409e-05_dp, -9.19296736666106e-04_dp, 6.39288223132545e-10_dp, &
          7.53259479898699e-07_dp, -4.00321478682929e-13_dp, 7.56140294351614e-09_dp, &
          -9.12082054034891e-12_dp, -2.37612381140539e-08_dp, 2.69586010591874e-05_dp, &
          -7.32828135157839e-11_dp, 2.41995578306660e-10_dp, -4.05735532730322e-04_dp, &
          1.89424143498011e-10_dp, -4.86632965074563e-10_dp, 0.00000000000000e+00_dp, &
          4.12209020652996e-05_dp, -1.14987238280587e+06_dp, 9.48180885032080e+09_dp, &
          -1.95788865718971e+17_dp, 4.96250704871300e+24_dp, -1.05549884548496e+28_dp, &
          -7.58642165988278e+11_dp, -9.22172769596101e+22_dp, 7.25379072059348e+29_dp, &
          -6.17718249205859e+01_dp, 1.07555033344858e+04_dp, -3.79545802336487e+07_dp, &
          2.28646846221831e+11_dp, -4.99741093010619e+06_dp, -2.80214310054101e+30_dp, &
          1.04915406769586e+06_dp, 6.13754229168619e+27_dp, 8.02056715528378e+31_dp, &
          -2.98617819828065e+07_dp, -9.10782540134681e+01_dp, 1.35033227281565e+05_dp, &
          -7.12949383408211e+18_dp, -1.04578785289542e+36_dp, 3.04331584444093e+01_dp, &
          5.93250797959445e+09_dp, -3.64174062110798e+27_dp, 9.21791403532461e-01_dp, &
          -3.37693609657471e-01_dp, -7.24644143758508e+01_dp, -1.10480239272601e-01_dp, &
          5.36516031875059e+00_dp, -2.91441872156205e+03_dp, 6.16338176535305e+39_dp, &
          -1.20889175861180e+38_dp, 8.18396024524612e+22_dp, 9.40781944835829e+08_dp, &
          -3.67279669545448e+04_dp, -8.37513931798655e+15_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 5.61379678887577e-02_dp, 7.74135421587083e+09_dp, &
          1.11482975877938e-09_dp, -1.43987128208183e-03_dp, 1.93696558764920e+03_dp, &
          -6.05971823585005e+08_dp, 1.71951568124337e+13_dp, -1.85461154985145e+16_dp, &
          3.87851168078010e-17_dp, -3.95464327846105e-14_dp, -1.70875935679023e+02_dp, &
          -2.12010620701220e+03_dp, 1.77683337348191e+07_dp, 1.10177443629575e+01_dp, &
          -2.34396091693313e+05_dp, -6.56174421999594e+06_dp, 1.56362212977396e-05_dp, &
          -2.12946257021400e+00_dp, 1.35249306374858e+01_dp, 1.77189164145813e-01_dp, &
          1.39499167345464e+03_dp, -7.03670932036388e-03_dp, -1.52011044389648e-01_dp, &
          9.81916922991113e-05_dp, 1.47199658618076e-03_dp, 2.02618487025578e+01_dp, &
          8.99345518944240e-01_dp, -2.11346402240858e-01_dp, 2.49971752957491e+01_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 1.06905684359136e+00_dp, &
          -1.48620857922333e+00_dp, 2.59862256980408e+14_dp, -4.46352055678749e-12_dp, &
          -5.66620757170032e-07_dp, -2.35302885736849e-03_dp, -2.69226321968839e-01_dp, &
          9.22024992944392e+00_dp, 3.57633505503772e-12_dp, -1.73942565562222e+01_dp, &
          7.00681785556229e-06_dp, -2.67050351075768e-04_dp, -2.31779669675624e+00_dp, &
          -7.53533046979752e-13_dp, 4.81337131452891e+00_dp, -2.23286270422356e+21_dp, &
          -1.18746004987383e-05_dp, 6.46412934136496e-03_dp, -4.10588536330937e-10_dp, &
          4.22739537057241e+19_dp, 3.13698180473812e-13_dp, 1.64395334345040e-24_dp, &
          -3.39823323754373e-06_dp, -1.35268639905021e-02_dp, -7.23252514211625e-15_dp, &
          1.84386437538366e-09_dp, -4.63959533752385e-02_dp, -9.92263100376750e+13_dp, &
          6.88169154439335e-17_dp, -2.22620998452197e-11_dp, -5.40843018624083e-08_dp, &
          3.45570606200257e-03_dp, 4.22275800304086e+10_dp, -1.26974478770487e-15_dp, &
          9.27237985153679e-10_dp, 6.12670812016489e-14_dp, -7.22693924063497e-12_dp, &
          -3.83669502636822e-04_dp, 3.74684572410204e-04_dp, -9.31976897511086e+04_dp, &
          -2.47690616026922e-02_dp, 6.58110546759474e+01_dp, 0.00000000000000e+00_dp, &
          -1.11371317395540e-04_dp, 1.00342892423685e+00_dp, 5.30615581928979e+00_dp, &
          1.79058760078792e-06_dp, -7.28541958464774e-04_dp, -1.87576133371704e+01_dp, &
          1.99060874071849e-03_dp, 2.43574755377290e+01_dp, -1.77040785499444e-04_dp, &
          -2.59680385227130e-03_dp, -1.98704578406823e+02_dp, 7.38627790224287e-05_dp, &
          -2.36264692844138e-03_dp, -1.61023121314333e+00_dp, 6.22322971786473e+03_dp, &
          -9.60754116701669e-09_dp, -5.10572269720488e-11_dp, 7.67373781404211e-03_dp, &
          6.63855469485254e-15_dp, -7.17590735526745e-10_dp, 1.46564542926508e-05_dp, &
          3.09029474277013e-12_dp, -4.64216300971708e-16_dp, -3.90499637961161e-14_dp, &
          -2.36716126781431e-10_dp, 4.54652854268717e-12_dp, -4.22271787482497e-03_dp, &
          2.83911742354706e-11_dp, 2.70929002720228e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, -4.01215699576099e+08_dp, 4.84501478318406e+10_dp, &
          3.94721471363678e-15_dp, 3.72629967374147e+04_dp, -3.69794374168666e-30_dp, &
          -3.80436407012452e-15_dp, 4.75361629970233e-07_dp, -8.79148916140706e-04_dp, &
          8.44317863844331e-01_dp, 1.22433162656600e+01_dp, -1.04529634830279e+02_dp, &
          5.89702771277429e+02_dp, -2.91026851164444e+13_dp, 1.70343072841850e-06_dp, &
          -2.77617606975748e-04_dp, -3.44709605486686e+00_dp, 2.21333862447095e+01_dp, &
          -1.94646110037079e+02_dp, 8.08354639772825e-16_dp, -1.80845209145470e-11_dp, &
          -6.96664158132412e-06_dp, -1.81057560300994e-03_dp, 2.55830298579027e+00_dp, &
          3.28913873658481e+03_dp, -1.73270241249904e-19_dp, -6.61876792558034e-07_dp, &
          -3.95688923421250e-03_dp, 6.04203299819132e-18_dp, -4.00879935920517e-14_dp, &
          1.60751107464958e-09_dp, 3.83719409025556e-05_dp, -6.49565446702457e-15_dp, &
          -1.49095328506000e-12_dp, 5.41449377329581e-09_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 2.60702058647537e+09_dp, &
          -1.88277213604704e+14_dp, 5.54923870289667e+18_dp, -7.58966946387758e+22_dp, &
          4.13865186848908e+26_dp, -8.15038000738060e+11_dp, -3.81458260489955e+32_dp, &
          -1.23239564600519e-02_dp, 2.26095631437174e+07_dp, -4.95017809506720e+11_dp, &
          5.29482996422863e+15_dp, -4.44359478746295e+22_dp, 5.21635864527315e+34_dp, &
          -4.87095672740742e+54_dp, -7.14430209937547e+05_dp, 1.27868634615495e-01_dp, &
          -1.00752127917598e+01_dp, 7.77451437960990e+06_dp, -1.08105480796471e+24_dp, &
          -3.57578581169659e-06_dp, -2.12857169423484e+00_dp, 2.70706111085238e+29_dp, &
          -6.95953622348829e+32_dp, 1.10609027472280e-01_dp, 7.21559163361354e+01_dp, &
          -3.06367307532219e+14_dp, 2.65839618885530e-05_dp, 2.53392392889754e-02_dp, &
          -2.14443041836579e+02_dp, 9.37846601489667e-01_dp, 2.23184043101700e+00_dp, &
          3.38401222509191e+01_dp, 4.94237237179718e+20_dp, -1.98068404154428e-01_dp, &
          -1.41415349881140e+30_dp, -9.93862421613651e+01_dp, 1.25070534142731e+02_dp, &
          -9.96473529004439e+02_dp, 4.73137909872765e+04_dp, 1.16662121219322e+32_dp, &
          -3.15874976271533e+15_dp, -4.45703369196945e+32_dp, 6.42794932373694e+32_dp, &
          8.11384363481847e-01_dp, -5.68199310990094e+03_dp, -1.78657198172556e+10_dp, &
          7.95537657613427e+31_dp, -8.14568209346872e+04_dp, -6.59774567602874e+07_dp, &
          -1.52861148659302e+10_dp, -5.60165667510446e+11_dp, 4.58384828593949e+05_dp, &
          -3.85754000383848e+13_dp, 4.53735800004273e+07_dp, 9.39454935735563e+11_dp, &
          2.66572856432938e+27_dp, -5.47578313899097e+09_dp, 2.00725701112386e+14_dp, &
          1.85007245563239e+12_dp, 1.85135446828337e+08_dp, -1.70451090076385e+11_dp, &
          1.57890366037614e+14_dp, -2.02530509748774e+15_dp, 3.68193926183570e+59_dp, &
          1.70215539458936e+17_dp, 6.39234909918741e+41_dp, -8.21698160721956e+14_dp, &
          -7.95260241872306e+23_dp, 2.33415869478510e+17_dp, -6.00079934586803e+22_dp, &
          5.94584382273384e+24_dp, 1.89461279349492e+39_dp, -8.10093428842645e+45_dp, &
          1.88813911076809e+21_dp, 1.11052244098768e+35_dp, 2.91133958602503e+45_dp, &
          -3.29421923951460e+21_dp, -1.37570282536696e+25_dp, 1.81508996303902e+27_dp, &
          -3.46865122768353e+29_dp, -2.11961148774260e+37_dp, -1.28617899887675e+48_dp, &
          4.79817895699239e+64_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 2.80967799943151e-39_dp, 6.14869006573609e-31_dp, &
          5.82238667048942e-28_dp, 3.90628369238462e-23_dp, 8.21445758255119e-21_dp, &
          4.02137961842776e-15_dp, 6.51718171878301e-13_dp, -2.11773355803058e-08_dp, &
          2.64953354380072e-03_dp, -1.35031446451331e-32_dp, -6.07246643970893e-24_dp, &
          -4.02352115234494e-19_dp, -7.44938506925544e-17_dp, 1.89917206526237e-13_dp, &
          3.64975183508473e-06_dp, 1.77274872361946e-26_dp, -3.34952758812999e-19_dp, &
          -4.21537726098389e-09_dp, -3.91048167929649e-02_dp, 5.41276911564176e-14_dp, &
          7.05412100773699e-12_dp, 2.58585887897486e-09_dp, -4.93111362030162e-11_dp, &
          -1.58649699894543e-06_dp, -5.25037427886100e-01_dp, 2.20019901729615e-03_dp, &
          -6.43064132636925e-03_dp, 6.29154149015048e+01_dp, 1.35147318617061e+02_dp, &
          2.40560808321713e-07_dp, -8.90763306701305e-04_dp, -4.40209599407714e+03_dp, &
          -3.02807107747776e+02_dp, 1.59158748314599e+03_dp, 2.32534272709876e+05_dp, &
          -7.92681207132600e+05_dp, -8.69871364662769e+10_dp, 3.54542769185671e+11_dp, &
          4.00849240129329e+14_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 1.28746023979718e-35_dp, &
          -7.35234770382342e-12_dp, 2.89078692149150e-03_dp, 2.44482731907223e-01_dp, &
          1.41733492030985e-24_dp, -3.54533853059476e-29_dp, -5.94539202901431e-18_dp, &
          -5.85188401782779e-09_dp, 2.01377325411803e-06_dp, 1.38647388209306e+00_dp, &
          -1.73959365084772e-05_dp, 1.37680878349369e-03_dp, 8.14897605805513e-15_dp, &
          4.25596631351839e-26_dp, -3.87449113787755e-18_dp, 1.39814747930240e-13_dp, &
          -1.71849638951521e-03_dp, 6.41890529513296e-22_dp, 1.18960578072018e-11_dp, &
          -1.55282762571611e-18_dp, 2.33907907347507e-08_dp, -1.74093247766213e-13_dp, &
          3.77682649089149e-09_dp, -5.16720236575302e-11_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          -9.82825342010366e-05_dp, 1.05145700850612e+00_dp, 1.16033094095084e+02_dp, &
          3.24664750281543e+03_dp, -1.23592348610137e+03_dp, -5.61403450013495e-02_dp, &
          8.56677401640869e-08_dp, 2.36313425393924e+02_dp, 9.72503292350109e-03_dp, &
          -1.03001994531927e+00_dp, -1.49653706199162e-09_dp, -2.15743778861592e-05_dp, &
          -8.34452198291445e+00_dp, 5.86602660564988e-01_dp, 3.43480022104968e-26_dp, &
          8.16256095947021e-06_dp, 2.94985697916798e-03_dp, 7.11730466276584e-17_dp, &
          4.00954763806941e-10_dp, 1.07766027032853e+01_dp, -4.09449599138182e-07_dp, &
          -7.29121307758902e-06_dp, 6.77107970938909e-09_dp, 6.02745973022975e-08_dp, &
          -3.82323011855257e-11_dp, 1.79946628317437e-03_dp, -3.45042834640005e-04_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, -8.20433843259950e+04_dp, 4.73271518461586e+10_dp, &
          -8.05950021005413e-02_dp, 3.28600025435980e+01_dp, -3.56617029982490e+03_dp, &
          -1.72985781433335e+09_dp, 3.51769232729192e+07_dp, -7.75489259985144e+05_dp, &
          7.10346691966018e-05_dp, 9.93499883820274e+04_dp, -6.42094171904570e-01_dp, &
          -6.12842816820083e+03_dp, 2.32808472983776e+02_dp, -1.42808220416837e-05_dp, &
          -6.43596060678456e-03_dp, -4.28577227475614e+00_dp, 2.25689939161918e+03_dp, &
          1.00355651721510e-03_dp, 3.33491455143516e-01_dp, 1.09697576888873e+00_dp, &
          9.61917379376452e-01_dp, -8.38165632204598e-02_dp, 2.47795908411492e+00_dp, &
          -3.19114969006533e+03_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 1.44165955660863e-03_dp, &
          -7.01438599628258e+12_dp, -8.30946716459219e-17_dp, 2.61975135368109e-01_dp, &
          3.93097214706245e+02_dp, -1.04334030654021e+04_dp, 4.90112654154211e+08_dp, &
          -1.47104222772069e-04_dp, 1.03602748043408e+00_dp, 3.05308890065089e+00_dp, &
          -3.99745276971264e+06_dp, 5.69233719593750e-12_dp, -4.64923504407778e-02_dp, &
          -5.35400396512906e-18_dp, 3.99988795693162e-13_dp, -5.36479560201811e-07_dp, &
          1.59536722411202e-02_dp, 2.70303248860217e-15_dp, 2.44247453858506e-08_dp, &
          -9.83430636716454e-06_dp, 6.63513144224454e-02_dp, -9.93456957845006e+00_dp, &
          5.46491323528491e+02_dp, -1.43365406393758e+04_dp, 1.50764974125511e+05_dp, &
          -3.37209709340105e-10_dp, 3.77501980025469e-09_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          -5.32466612140254e+22_dp, 1.00415480000824e+31_dp, -1.91540001821367e+29_dp, &
          1.05618377808847e+16_dp, 2.02281884477061e+58_dp, 8.84585472596134e+07_dp, &
          1.66540181638363e+22_dp, -3.13563197669111e+05_dp, -1.85662327545324e+53_dp, &
          -6.24942093918942e-02_dp, -5.04160724132590e+09_dp, 1.87514491833092e+04_dp, &
          1.21399979993217e-03_dp, 1.88317043049455e+00_dp, -1.67073503962060e+03_dp, &
          9.65961650599775e-01_dp, 2.94885696802488e+00_dp, -6.53915627346115e+04_dp, &
          6.04012200163444e+49_dp, -1.98339358557937e-01_dp, -1.75984090163501e+57_dp, &
          3.56314881403987e+00_dp, -5.75991255144384e+02_dp, 4.56213415338071e+04_dp, &
          -1.09174044987829e+07_dp, 4.37796099975134e+33_dp, -6.16552611135792e+45_dp, &
          1.93568768917797e+09_dp, 9.50898170425042e+53_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 1.55287249586268e+00_dp, 6.64235115009031e+00_dp, &
          -2.89366236727210e+03_dp, -3.85923202309848e+12_dp, -2.91002915783761e+00_dp, &
          -8.29088246858083e+11_dp, 1.76814899675218e+00_dp, -5.34686695713469e+08_dp, &
          1.60464608687834e+17_dp, 1.96435366560186e+05_dp, 1.56637427541729e+12_dp, &
          -1.78154560260006e+00_dp, -2.29746237623692e+15_dp, 3.85659001648006e+07_dp, &
          1.10554446790543e+09_dp, -6.77073830687349e+13_dp, -3.27910592086523e+30_dp, &
          -3.41552040860644e+50_dp, -5.27251339709047e+20_dp, 2.45375640937055e+23_dp, &
          -1.68776617209269e+26_dp, 3.58958955867578e+28_dp, -6.56475280339411e+35_dp, &
          3.55286045512301e+38_dp, 5.69021454413270e+57_dp, -7.00584546433113e+47_dp, &
          -7.05772623326374e+64_dp, 1.66861176200148e+52_dp, -3.00475129680486e+60_dp, &
          -6.68481295196808e+50_dp, 4.28432338620678e+68_dp, -4.44227367758304e+71_dp, &
          -2.81396013562745e+76_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 1.22088349258355e+17_dp, &
          1.04216468608488e+09_dp, -8.82666931564652e+15_dp, 2.59929510849499e+19_dp, &
          2.22612779142211e+14_dp, -8.78473585050085e+17_dp, -3.14432577551552e+21_dp, &
          -2.16934916996285e+12_dp, 1.59079648196849e+20_dp, -3.39567617303423e+02_dp, &
          8.84387651337836e+12_dp, -8.43405926846418e+20_dp, 1.14178193518022e+01_dp, &
          -1.22708229235641e-04_dp, -1.06201671767107e+02_dp, 9.03443213959313e+24_dp, &
          -6.93996270370852e+27_dp, 6.48916718965575e-09_dp, 7.18957567127851e+03_dp, &
          1.05581745346187e-03_dp, -6.51903203602581e+14_dp, -1.60116813274676e+24_dp, &
          -5.10254294237837e-09_dp, -1.52355388953402e-01_dp, 6.77143292290144e+11_dp, &
          2.76378438378930e+14_dp, 1.16862983141686e-02_dp, -3.01426947980171e+13_dp, &
          1.69719813884840e-08_dp, 1.04674840020929e+26_dp, -1.08016904560140e+04_dp, &
          -9.90623601934295e-13_dp, 5.36116483602738e+06_dp, 2.26145963747881e+21_dp, &
          -4.88731565776210e-10_dp, 1.51001548880670e-05_dp, -2.27700464643920e+04_dp, &
          -7.81754507698846e+27_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          -4.15652812061591e-55_dp, 1.77441742924043e-61_dp, -3.57078668203377e-55_dp, &
          3.59252213604114e-26_dp, -2.59123736380269e+01_dp, 5.94619766193460e+04_dp, &
          -6.24184007103158e+10_dp, 3.13080299915944e+16_dp, 1.05006446192036e-09_dp, &
          -1.92824336984852e-06_dp, 6.54144373749937e+05_dp, 5.13117462865044e+12_dp, &
          -6.97595750347391e+18_dp, -1.03977184454767e+28_dp, 1.19563135540666e-48_dp, &
          -4.36677034051655e-42_dp, 9.26990036530639e-30_dp, 5.87793105620748e+20_dp, &
          2.80375725094731e-18_dp, -1.92359972440634e+22_dp, 7.42705723302738e+26_dp, &
          -5.17429682450605e+01_dp, 8.20612048645469e+06_dp, -1.88214882341448e-09_dp, &
          1.84587261114837e-02_dp, -1.35830407782663e-06_dp, -7.23681885626348e+16_dp, &
          -2.23449194054124e+26_dp, -1.11526741826431e-35_dp, 2.76032601145151e-29_dp, &
          1.34856491567853e+14_dp, 6.52440293345860e-10_dp, 5.10655119774360e+16_dp, &
          -4.68138358908732e+31_dp, -7.60667491183279e+15_dp, -4.17247986986821e-19_dp, &
          3.12545677756104e+13_dp, -1.00375333864186e+14_dp, 2.47761392329058e+26_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, -5.86219133817016e-08_dp, -8.94460355005526e+10_dp, &
          5.31168037519774e-31_dp, 1.09892402329239e-01_dp, -5.75368389425212e-02_dp, &
          2.28276853990249e+04_dp, -1.58548609655002e+18_dp, 3.29865748576503e-28_dp, &
          -6.34987981190669e-25_dp, 6.15762068640611e-09_dp, -9.61109240985747e+07_dp, &
          -4.06274286652625e-45_dp, -4.71103725498077e-13_dp, 7.25937724828145e-01_dp, &
          1.87768525763682e-39_dp, -1.03308436323771e+03_dp, -6.62552816342168e-02_dp, &
          5.79514041765710e+02_dp, 2.37416732616644e-27_dp, 2.71700235739893e-15_dp, &
          -9.07886213483600e+01_dp, -1.71242509570207e-37_dp, 1.56792067854621e+02_dp, &
          9.23261357901470e-01_dp, -5.97865988422577e+00_dp, 3.21988767636389e+06_dp, &
          -3.99441390042203e-30_dp, 4.93429086046981e-08_dp, 8.12036983370565e-20_dp, &
          -2.07610284654137e-12_dp, -3.40821291419719e-07_dp, 5.42000573372233e-18_dp, &
          -8.56711586510214e-13_dp, 2.66170454405981e-14_dp, 8.58133791857099e-06_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 3.77373741298151e+18_dp, &
          -5.07100883722913e+12_dp, -1.03363225598860e+15_dp, 1.84790814320773e-06_dp, &
          -9.24729378390945e-04_dp, -4.25999562292738e+23_dp, -4.62307771873973e-13_dp, &
          1.07319065855767e+21_dp, 6.48662492280682e+10_dp, 2.44200600688281e+00_dp, &
          -8.51535733484258e+09_dp, 1.69894481433592e+21_dp, 2.15780222509020e-27_dp, &
          -3.20850551367334e-01_dp, -3.82642448458610e+16_dp, -2.75386077674421e-29_dp, &
          -5.63199253391666e+05_dp, -3.26068646279314e+20_dp, 3.97949001553184e+13_dp, &
          1.00824008584757e-07_dp, 1.62234569738433e+04_dp, -4.32355225319745e+10_dp, &
          -5.92874245598610e+11_dp, 1.33061647281106e+00_dp, 1.57338197797544e+06_dp, &
          2.58189614270853e+13_dp, 2.62413209706358e+24_dp, -9.20011937431142e-02_dp, &
          2.20213765905426e-03_dp, -1.10433759109547e+01_dp, 8.47004870612087e+06_dp, &
          -5.92910695762536e+08_dp, -1.83027173269660e-05_dp, 1.81339603516302e-01_dp, &
          -1.19228759669889e+03_dp, 4.30867658061468e+06_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          -5.25597995024633e-10_dp, 5.83441305228407e+03_dp, -1.34778968457925e+16_dp, &
          1.18973500934212e+25_dp, -1.59096490904708e+26_dp, -3.15839902302021e-07_dp, &
          4.96212197158239e+02_dp, 3.27777227273171e+18_dp, -5.27114657850696e+21_dp, &
          2.10017506281863e-17_dp, 7.05106224399834e+20_dp, -2.66713136106469e+30_dp, &
          -1.45370512554562e-08_dp, 1.49333917053130e+27_dp, -1.49795620287641e+07_dp, &
          -3.81881906271100e+15_dp, 7.24660165585797e-05_dp, -9.37808169550193e+13_dp, &
          5.14411468376383e+09_dp, -8.28198594040141e+04_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 2.44007892290650e-11_dp, -4.63057430331242e+06_dp, &
          7.28803274777712e+09_dp, 3.27776302858856e+15_dp, -1.10598170118409e+09_dp, &
          -3.23899915729957e+12_dp, 9.23814007023245e+15_dp, 8.42250080413712e-13_dp, &
          6.63221436245506e+11_dp, -1.67170186672139e+14_dp, 2.53749358701391e+03_dp, &
          -8.19731559610523e-21_dp, 3.28380587890663e+11_dp, -6.25004791171543e+07_dp, &
          8.03197957462023e+20_dp, -2.04397011338353e-11_dp, -3.78391047055938e+03_dp, &
          9.72876545938620e-03_dp, 1.54355721681459e+01_dp, -3.73962862928643e+03_dp, &
          -6.82859011374572e+10_dp, -2.48488015614543e-04_dp, 3.94536049497068e+06_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp, 0.00000000000000e+00_dp, &
          0.00000000000000e+00_dp, 0.00000000000000e+00_dp], &
          [43,26])

     PetscReal, public :: widom_slope = 6.479 !! Slope A_s of Widom line for water (Banuti et al., 2017)
     PetscReal, public :: widom_delta_growth !! Widom delta width growth factor
     PetscReal, public :: widom_delta_min !! Minimum temperature width of Widom delta at critical point
     PetscReal, public :: widom_delta_min_pressure !! Minimum pressure width of Widom delta at critical point
     PetscReal, public :: widom_delta_zero_temperature !! Temperature at which Widom delta has zero width
     PetscReal, public :: widom_delta_zero_pressure !! Pressure at which Widom delta has zero width

   contains
     private
     procedure, public :: init => region3_init
     procedure, public :: destroy => region3_destroy
     procedure, public :: properties => region3_properties
     procedure, public :: dpdd => region3_dpdd
     procedure, public :: subregion_index => region3_subregion_index
     procedure, public :: auxiliary_subregion_index => region3_auxiliary_subregion_index
     procedure, public :: density => region3_density
     procedure, public :: subregion_boundary_poly => region3_subregion_boundary_poly
     procedure, public :: subregion_boundary_logpoly => region3_subregion_boundary_logpoly
     procedure, public :: subregion_boundary_3ef => region3_subregion_boundary_3ef
     procedure, public :: widom => region3_widom
     procedure, public :: widom_delta => region3_widom_delta
     procedure, public :: pi_liquidlike => region3_pi_liquidlike
  end type IAPWS_region3_type

!------------------------------------------------------------------------
! Region 2/3 boundary type
!------------------------------------------------------------------------

  type, public :: IAPWS_boundary23_type
     !! IAPWS-97 boundary between regions 2 and 3.
     private
     PetscReal :: pstar = 1.0e6_dp
     PetscReal :: n(5) = [ &
          0.34805185628969e3_dp, -0.11671859879975e1_dp, 0.10192970039326e-2_dp, &
          0.57254459862746e3_dp,  0.13918839778870e2_dp]
     contains
       private
       procedure, public :: temperature => boundary23_temperature
       procedure, public :: pressure => boundary23_pressure
    end type IAPWS_boundary23_type

!------------------------------------------------------------------------
! Region 3/4 boundary type
!------------------------------------------------------------------------

  type, public :: IAPWS_boundary34_type
     !! IAPWS-97 boundary between regions 3 and 4.
     private
     type(IAPWS_type), pointer :: thermo
     PetscReal :: nl(5) = [ &
          2.6115477832256123e-2_dp, 7.3090461427095868e-2_dp, &
          1.4134075574694979e-1_dp, -2.0686303830304370e-1_dp, &
          8.8225881014818222e-2_dp]
     PetscReal :: nv(5) = [3.6910201854073885e-2_dp, &
          -9.4257129728909567e-2_dp, 8.7475694209829347e-1_dp, &
          -1.1897239584539256_dp, 7.5871570867547866e-1_dp]
     contains
       private
       procedure, public :: init => boundary34_init
       procedure, public :: temperature => boundary34_temperature
    end type IAPWS_boundary34_type

!------------------------------------------------------------------------
! IAPWS thermodynamics type
!------------------------------------------------------------------------

  type, extends(thermodynamics_type), public :: IAPWS_type
     !! IAPWS thermodynamics type.
     private
     type(IAPWS_boundary23_type), public :: boundary23
     type(IAPWS_boundary34_type), public :: boundary34
     PetscReal, public :: temperature_bdy_1_3 !! Temperature of boundary between regions 1 & 3
     PetscReal, public :: saturation_pressure_bdy_1_3 !! Saturation pressure at boundary between regions 1 & 3
     PetscReal, public :: min_liquid_density_bdy_1_3, max_vapour_density_bdy_1_3
   contains
     private
     procedure, public :: init => IAPWS_init
     procedure, public :: destroy => IAPWS_destroy
     procedure, public :: phase_composition => IAPWS_phase_composition
  end type IAPWS_type

!------------------------------------------------------------------------

contains

!------------------------------------------------------------------------
! IAPWS class
!------------------------------------------------------------------------

  subroutine IAPWS_init(self, json, logfile)
    !! Initializes IAPWS object.

    use fson
    use fson_value_m, only: TYPE_OBJECT
    use fson_mpi_module
    use logfile_module

    class(IAPWS_type), intent(in out) :: self
    type(fson_value), pointer, intent(in), optional :: json !! JSON input object
    type(logfile_type), intent(in out), optional :: logfile
    ! Locals:
    PetscInt :: i, thermo_type
    PetscBool :: defaults
    PetscReal :: Psat, props(2)
    PetscErrorCode :: err
    PetscBool, parameter :: default_extrapolate = PETSC_FALSE
    PetscReal, parameter :: default_widom_delta_growth = 25._dp
    PetscReal, parameter :: default_widom_delta_min = 0.1_dp

    self%name = "IAPWS-97"

    self%max_temperature = 800._dp
    self%max_pressure = 100.e6_dp
    self%temperature_bdy_1_3 = 350._dp
    self%critical = critical

    allocate(IAPWS_saturation_type :: self%saturation)
    call self%saturation%init(self)
    call self%saturation%pressure(self%temperature_bdy_1_3, &
         self%saturation_pressure_bdy_1_3, err)

    self%num_regions = 3
    allocate(IAPWS_region1_type :: self%water)
    allocate(IAPWS_region2_type :: self%steam)
    allocate(IAPWS_region3_type :: self%supercritical)
    allocate(self%region(self%num_regions))

    call self%region(1)%set(self%water)
    call self%region(2)%set(self%steam)
    call self%region(3)%set(self%supercritical)

    defaults = PETSC_TRUE
    if (present(json)) then
       if (fson_has_mpi(json, "thermodynamics")) then
          thermo_type = fson_type_mpi(json, "thermodynamics")
          if (thermo_type == TYPE_OBJECT) then
             call fson_get_mpi(json, "thermodynamics.extrapolate", &
                  default_extrapolate, self%extrapolate, logfile)
             select type (region3 => self%supercritical)
             type is (IAPWS_region3_type)
                call fson_get_mpi(json, "thermodynamics.widom.delta.growth", &
                     default_widom_delta_growth, region3%widom_delta_growth, &
                     logfile)
                call fson_get_mpi(json, "thermodynamics.widom.delta.min", &
                     default_widom_delta_growth, region3%widom_delta_min, &
                     logfile)
             end select
             defaults = PETSC_FALSE
          end if
       end if
    end if

    if (defaults) then
       self%extrapolate = default_extrapolate
       if (present(logfile)) then
          call logfile%write(LOG_LEVEL_INFO, 'input', 'default', &
               logical_keys = ['thermodynamics.extrapolate'], &
               logical_values = [default_extrapolate])
       end if
       select type (region3 => self%supercritical)
       type is (IAPWS_region3_type)
          region3%widom_delta_growth = default_widom_delta_growth
          region3%widom_delta_min = default_widom_delta_min
          if (present(logfile)) then
             call logfile%write(LOG_LEVEL_INFO, 'input', 'default', &
                  real_keys = ['thermodynamics.widom.delta.growth', &
                  '   thermodynamics.widom.delta.min'], &
                  real_values = [default_widom_delta_growth, &
                  default_widom_delta_min])
          end if
       end select
    end if

    do i = 1, self%num_regions
       call self%region(i)%ptr%init(self)
    end do

    ! Reference densities at region 1/3 boundary:
    call self%saturation%pressure(self%temperature_bdy_1_3, Psat, err)
    call self%water%properties([Psat, self%temperature_bdy_1_3], props, err)
    self%min_liquid_density_bdy_1_3 = props(1)
    call self%steam%properties([Psat, self%temperature_bdy_1_3], props, err)
    self%max_vapour_density_bdy_1_3 = props(1)

    call self%boundary34%init(self)

  end subroutine IAPWS_init

!------------------------------------------------------------------------

  subroutine IAPWS_destroy(self)
    !! Destroys IAPWS object.

    class(IAPWS_type), intent(in out) :: self
    ! Locals:
    PetscInt :: i
    
    do i = 1, self%num_regions
       call self%region(i)%ptr%destroy()
    end do
    deallocate(self%region)
    deallocate(self%water, self%steam, self%supercritical)
    deallocate(self%saturation)

  end subroutine IAPWS_destroy

!------------------------------------------------------------------------

  PetscInt function IAPWS_phase_composition(self, region, pressure, &
       temperature) result(phases)
    !! Returns phase composition integer for given region, pressure
    !! and temperature. Here the bits represent:
    !! 0: liquid
    !! 1: vapour
    !! 2: supercritical

    class(IAPWS_type), intent(in) :: self
    PetscInt, intent(in) :: region
    PetscReal, intent(in) :: pressure, temperature
    ! Locals:
    PetscReal :: saturation_pressure
    PetscInt :: ierr

    phases = int(b'000')

    if (region == 4) then
       phases = int(b'011')
    else
       if (temperature <= self%critical%temperature) then
          select case(region)
             case (1)
                phases = int(b'001')
             case (2)
                phases = int(b'010')
             case (3)
                call self%saturation%pressure(temperature, &
                     saturation_pressure, ierr)
                if (ierr == 0) then
                   if (pressure >= saturation_pressure) then
                      phases = int(b'001')
                   else
                      phases = int(b'010')
                   end if
                else
                   phases = -1 ! error in saturation pressure
                end if
             end select
       else
          if (pressure <= self%critical%pressure) then
             phases = int(b'010')
          else
             phases = int(b'100')
          end if
       end if
    end if

  end function IAPWS_phase_composition

!------------------------------------------------------------------------
! Sub-region 3 type
!------------------------------------------------------------------------

  subroutine subregion3_init(self, nustar, pstar, tstar, a, b, c, d, e, &
       exp_form, I, J, n)
    !! Initialise sub-region 3 type

    class(IAPWS_subregion3_type), intent(in out) :: self
    PetscReal, intent(in) :: nustar, pstar, tstar
    PetscReal, intent(in) :: a, b, c, d, e
    PetscBool, intent(in) :: exp_form
    PetscInt, intent(in) :: I(:), J(:)
    PetscReal, intent(in) :: n(:)

    self%nustar = nustar
    self%pstar = pstar
    self%tstar = tstar

    self%a = a
    self%b = b
    self%c = c
    self%d = d
    self%e = e

    self%exp_form = exp_form

    self%I = I
    self%J = J
    self%n = n

    call self%pi%configure(self%I)
    call self%pj%configure(self%J)

  end subroutine subregion3_init

!------------------------------------------------------------------------

  subroutine subregion3_destroy(self)
    !! Destroy sub-region 3 type

    class(IAPWS_subregion3_type), intent(in out) :: self

    call self%pi%destroy()
    call self%pj%destroy()

    deallocate(self%I, self%J, self%n)

  end subroutine subregion3_destroy

!------------------------------------------------------------------------

  PetscReal function subregion3_specific_volume(self, param) result(nu)
    !! Returns specific volume in sub-region 3.

    class(IAPWS_subregion3_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (pressure, temperature)
    ! Locals:
    PetscReal :: pi, theta, pt, tt

    associate (p => param(1), t => param(2))

      pi = p / self%pstar
      theta = (t + tc_k) / self%tstar

      if (self%exp_form) then
         pt = pi - self%a
         tt = theta - self%b
         call self%pi%compute(pt)
         call self%pj%compute(tt)
         nu = self%nustar * exp(sum(self%n * self%pi%power(self%I) * &
              self%pj%power(self%J)))
      else
         pt = (pi - self%a) ** self%c
         tt = (theta - self%b) ** self%d
         call self%pi%compute(pt)
         call self%pj%compute(tt)
         nu = self%nustar * (sum(self%n * self%pi%power(self%I) * &
              self%pj%power(self%J))) ** self%e
      end if

    end associate

  end function subregion3_specific_volume

!------------------------------------------------------------------------
! Abstract region type
!------------------------------------------------------------------------

  subroutine region_init(self, thermo)
    !! Initializes abstract IAPWS-97 region object.
    
    class(IAPWS_region_type), intent(in out) :: self
    class(thermodynamics_type), intent(in), target :: thermo

    self%thermo => thermo
    call self%visc%init()

  end subroutine region_init

!------------------------------------------------------------------------

  subroutine region_destroy(self)
    !! Destroys abstract IAPWS-97 region object.

    class(IAPWS_region_type), intent(in out) :: self

    call self%visc%destroy()

  end subroutine region_destroy

!------------------------------------------------------------------------

  subroutine region_properties(self, param, props, err)
    !! Dummy properties routine for abstract IAPWS-97 region object- to be
    !! overridden for specific regions.

    class(IAPWS_region_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables
    PetscReal, intent(out):: props(:) !! Properties
    PetscInt, intent(out) :: err !! error code

    props = 0._dp
    err = 0

  end subroutine region_properties

!------------------------------------------------------------------------

  subroutine region_pressure(self, param, pressure, err)
    !! Dummy properties routine for abstract IAPWS-97 region object- to be
    !! overridden for specific regions.

    class(IAPWS_region_type), intent(in out) :: self
    PetscReal, intent(in) :: param(2)
    PetscReal, intent(in out) :: pressure
    PetscErrorCode, intent(out) :: err

    pressure = 0._dp
    err = 0

  end subroutine region_pressure

!------------------------------------------------------------------------

  subroutine region_viscosity(self, temperature, pressure, density, viscosity)
    !! IAPWS viscosity routine.

    class(IAPWS_region_type), intent(in out) :: self
    PetscReal, intent(in) :: temperature !! Temperature
    PetscReal, intent(in) :: pressure    !! Pressure (not used)
    PetscReal, intent(in) :: density     !! Density
    PetscReal, intent(out) :: viscosity  !! Viscosity

    ! Locals:
    PetscReal:: del, tk, tau
    PetscReal:: mu0, mu1, s0, s1

    tk = temperature + tc_k
    tau = tk / self%thermo%critical%temperature_k
    del = density / self%thermo%critical%density

    call self%visc%pk%compute(1._dp / tau)
    call self%visc%pi%compute(self%visc%pk%power(1) - 1._dp)
    call self%visc%pj%compute(del - 1._dp)

    ! Viscosity in dilute-gas limit:
    s0 = dot_product(self%visc%h0, self%visc%pk%power(0:3))
    mu0 = 100._dp * dsqrt(tau) / s0

    ! Contribution due to finite density:
    s1 = sum(self%visc%pi%power(self%visc%I) * self%visc%h1 * self%visc%pj%power(self%visc%J))
    mu1 = exp(del*s1)

    viscosity = self%visc%mustar * mu0 * mu1

  end subroutine region_viscosity

!------------------------------------------------------------------------
! Region 1 (liquid water)
!------------------------------------------------------------------------

  subroutine region1_init(self, thermo)
    !! Initializes IAPWS region 1 object.

    class(IAPWS_region1_type), intent(in out) :: self
    class(thermodynamics_type), intent(in), target :: thermo
    ! Locals:
    PetscReal, parameter :: extrapolated_max_temperature = 360._dp

    call self%IAPWS_region_type%init(thermo)

    self%name = 'water'

    self%nI = self%n * self%I
    self%nJ = self%n * self%J
    self%I_1 = self%I - 1
    self%J_1 = self%J - 1

    ! Configure power tables:
    call self%pi%configure(self%I)
    call self%pi%configure(self%I_1)

    call self%pj%configure(self%J)
    call self%pj%configure(self%J_1)

    if (thermo%extrapolate) then
       self%max_temperature = extrapolated_max_temperature
    else
       select type (th => thermo)
       type is (IAPWS_type)
          self%max_temperature = th%temperature_bdy_1_3
       end select
    end if

  end subroutine region1_init

!------------------------------------------------------------------------

  subroutine region1_destroy(self)
    !! Destroys IAPWS region 1 object.

    class(IAPWS_region1_type), intent(in out) :: self

    call self%pi%destroy()
    call self%pj%destroy()

    call self%IAPWS_region_type%destroy()

  end subroutine region1_destroy

!------------------------------------------------------------------------

  subroutine region1_properties(self, param, props, err)
    !! Calculates density and internal energy of liquid water as a function of
    !! pressure (Pa) and temperature (deg C).
    !!
    !! Returns err = 1 if called outside its operating range (t<=self%max_temperature, p<=100 MPa).

    class(IAPWS_region1_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (pressure, temperature)
    PetscReal, intent(out):: props(:) !! (density, internal energy)
    PetscInt, intent(out) :: err !! error code
    ! Locals:
    PetscReal:: tk, rt, pi, tau, gampi, gamt
    
    associate (p => param(1), t => param(2))

      ! Check input:
      if ((t <= self%max_temperature).and.(p <= self%thermo%max_pressure)) then
         !      
         tk = t + tc_k
         rt = specific_gas_constant * tk
         pi = p / self%pstar
         tau = self%tstar / tk

         call self%pi%compute(7.1_dp - pi)
         call self%pj%compute(tau - 1.222_dp)

         gampi = -sum(self%nI * self%pi%power(self%I_1) * self%pj%power(self%J))
         gamt = sum(self%nJ * self%pi%power(self%I) * self%pj%power(self%J_1))

         props(1) = self%pstar / (rt * gampi)      ! density
         props(2) = rt * (tau * gamt - pi * gampi) ! internal energy
         err = 0

      else
         err = 1
      end if

    end associate

  end subroutine region1_properties

!------------------------------------------------------------------------

  subroutine region1_pressure(self, param, pressure, err)
    !! Returns pressure as a function of density and temperature. The
    !! pressure parameter is passed in with an initial estimate to
    !! start the iteration and on successful exit contains the result.

    class(IAPWS_region1_type), intent(in out) :: self
    PetscReal, intent(in) :: param(2)
    PetscReal, intent(in out) :: pressure
    PetscErrorCode, intent(out) :: err
    ! Locals:
    PetscInt, parameter :: maxit = 16
    PetscReal, parameter :: ftol = 1.e-4_dp
    PetscReal, parameter :: xtol = 1.e-3_dp, x_increment = 1.e-8_dp
    PetscReal :: Psat, P0_min
    PetscReal, parameter :: P0_min_default = 22.e6_dp, P0_max = 99.e6_dp
    PetscReal, parameter :: eps = 1.e-2_dp

    err = 0
    associate(density => param(1), temperature => param(2))
      call self%thermo%saturation%pressure(temperature, Psat, err)
    end associate
    if (err == 0) then
       P0_min = (1._dp + eps) * Psat
    else
       P0_min = P0_min_default
    end if
    pressure = min(max(pressure, P0_min), P0_max)

    call newton1d(f, pressure, ftol, xtol, maxit, x_increment, err)

  contains

!........................................................................

    PetscReal function f(x, err)
      PetscReal, intent(in) :: x
      PetscErrorCode, intent(out) :: err
      ! Locals:
      PetscReal :: props(2)

      associate(pressure => x, density => props(1), &
           d => param(1), t => param(2))
        call self%properties([pressure, t], props, err)
        f = density - d
      end associate

    end function f

  end subroutine region1_pressure

!------------------------------------------------------------------------
! Region 2 (steam)
!------------------------------------------------------------------------

  subroutine region2_init(self, thermo)
    !! Initializes IAPWS region 2 object.

    class(IAPWS_region2_type), intent(in out) :: self
    class(thermodynamics_type), intent(in), target :: thermo

    call self%IAPWS_region_type%init(thermo)

    self%name = 'steam'

    self%n0J0 = self%n0 * self%J0
    self%nI = self%n * self%I
    self%nJ = self%n * self%J
    self%J0_1 = self%J0 - 1
    self%I_1 = self%I - 1
    self%J_1 = self%J - 1

    ! Configure power tables:
    call self%pj0%configure(self%J0)
    call self%pj0%configure(self%J0_1)

    call self%pi%configure(self%I)
    call self%pi%configure(self%I_1)
    call self%pi%configure([-1]) ! also need pi%power(-1) to calculate gampi

    call self%pj%configure(self%J)
    call self%pj%configure(self%J_1)

  end subroutine region2_init

!------------------------------------------------------------------------

  subroutine region2_destroy(self)
    !! Destroys IAPWS region 2 object.

    class(IAPWS_region2_type), intent(in out) :: self

    call self%pj0%destroy()
    call self%pi%destroy()
    call self%pj%destroy()

    call self%IAPWS_region_type%destroy()

  end subroutine region2_destroy

!------------------------------------------------------------------------

  subroutine region2_properties(self, param, props, err)
    !! Calculates density and internal energy of dry steam as a function of
    !! pressure (Pa) and temperature (deg C).
    !!
    !! Returns err = 1 if called outside its operating range (t<=800 deg C, p<=100 MPa).

    class(IAPWS_region2_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (pressure, temperature)
    PetscReal, intent(out):: props(:)  !! (density, internal energy)
    PetscInt, intent(out) :: err  !! error code
    ! Locals:
    PetscReal:: tk, rt, pi, tau, gampir, gamt0, gamtr, gampi

    associate (p => param(1), t => param(2))

      ! Check input:
      if ((t <= self%thermo%max_temperature).and.(p <= self%thermo%max_pressure)) then

         tk = t + tc_k
         rt = specific_gas_constant * tk
         pi = p / self%pstar
         tau = self%tstar / tk

         call self%pj0%compute(tau)
         call self%pi%compute(pi)
         call self%pj%compute(tau - 0.5_dp)

         gamt0  = sum(self%n0J0 * self%pj0%power(self%J0_1))
         gampir = sum(self%nI * self%pi%power(self%I_1) * self%pj%power(self%J))
         gamtr  = sum(self%nJ * self%pi%power(self%I)   * self%pj%power(self%J_1))

         gampi = self%pi%power(-1) + gampir

         props(1) = self%pstar / (rt * gampi)                 ! density
         props(2) = rt * (tau * (gamt0 + gamtr) - pi * gampi) ! internal energy
         err = 0

      else
         err = 1
      end if

    end associate

  end subroutine region2_properties

!------------------------------------------------------------------------

  subroutine region2_pressure(self, param, pressure, err)
    !! Returns pressure as a function of density and temperature. The
    !! pressure parameter is passed in with an initial estimate to
    !! start the iteration and on successful exit contains the result.

    class(IAPWS_region2_type), intent(in out) :: self
    PetscReal, intent(in) :: param(2)
    PetscReal, intent(in out) :: pressure
    PetscErrorCode, intent(out) :: err
    ! Locals:
    PetscInt, parameter :: maxit = 16
    PetscReal, parameter :: ftol_rel = 1.e-7_dp, ftol_max = 1.e-5_dp
    PetscReal, parameter :: xtol = 1.e-3_dp, x_increment = 1.e-8_dp
    PetscReal, parameter :: P0_min = 10._dp
    PetscReal :: ftol, P_bdy, P0_max
    PetscReal, parameter :: eps = 1.e-2_dp

    err = 0
    associate(density => param(1), temperature => param(2))
      ftol = min(ftol_rel * density, ftol_max)
      select type (thermo => self%thermo)
      type is (IAPWS_type)
         if (temperature <= thermo%temperature_bdy_1_3) then
            call thermo%saturation%pressure(temperature, P_bdy, err)
         else
            call thermo%boundary23%pressure(temperature, P_bdy)
         end if
      end select
    end associate
    if (err == 0) then
       P0_max = (1._dp - eps) * P_bdy
       pressure = min(pressure, P0_max)
    end if
    pressure = max(pressure, P0_min)

    call newton1d(f, pressure, ftol, xtol, maxit, x_increment, err)

  contains

!........................................................................

    PetscReal function f(x, err)
      PetscReal, intent(in) :: x
      PetscErrorCode, intent(out) :: err
      ! Locals:
      PetscReal :: props(2)

      associate(pressure => x, density => props(1), &
           d => param(1), t => param(2))
        call self%properties([pressure, t], props, err)
        f = density - d
      end associate

    end function f

  end subroutine region2_pressure

!------------------------------------------------------------------------
! Region 3 (supercritical)
!------------------------------------------------------------------------

  subroutine region3_init(self, thermo)
    !! Initializes IAPWS region 3 object.

    class(IAPWS_region3_type), intent(in out) :: self
    class(thermodynamics_type), intent(in), target :: thermo
    ! Locals:
    PetscInt :: i
    PetscErrorCode :: err

    call self%IAPWS_region_type%init(thermo)

    self%name = 'supercritical'

    self%nI = self%n * self%I
    self%nJ = self%n * self%J
    self%I_1 = self%I - 1
    self%I_2 = self%I - 2
    self%J_1 = self%J - 1

    ! Configure power tables:
    call self%pi%configure(self%I)
    call self%pi%configure(self%I_1)

    call self%pi2%configure(self%I_1)
    call self%pi2%configure(self%I_2)

    call self%pj%configure(self%J)
    call self%pj%configure(self%J_1)

    self%dstar = self%thermo%critical%density
    self%tstar = self%thermo%critical%temperature_k

    call self%thermo%saturation%pressure(643.15_dp - tc_k, &
         self%psat_643, err)
    call self%thermo%saturation%pressure(623.15_dp - tc_k, &
         self%psat_623, err)

    do i = 1, self%num_subregions
       associate(N => self%subregion_num_consts(i))
         call self%subregion(i)%init(self%subregion_nustar(i), &
              self%subregion_pstar(i), self%subregion_tstar(i), &
              self%subregion_a(i), self%subregion_b(i), self%subregion_c(i), &
              self%subregion_d(i), self%subregion_e(i), self%subregion_exp_form(i), &
              self%subregion_I(1:N,i), self%subregion_J(1:N,i), &
              self%subregion_n(1:N,i))
       end associate
    end do

    ! Auxiliary Widom delta parameters:
    self%widom_delta_min_pressure = self%widom_delta_min * &
         self%thermo%critical%pressure / self%widom_delta_growth
    self%widom_delta_zero_pressure = self%thermo%critical%pressure - &
         self%widom_delta_min_pressure
    call self%widom(self%widom_delta_zero_pressure, &
         self%widom_delta_zero_temperature, err)

  end subroutine region3_init

!------------------------------------------------------------------------

  subroutine region3_destroy(self)
    !! Destroyes IAPWS region 3 object.

    class(IAPWS_region3_type), intent(in out) :: self
    ! Locals:
    PetscInt :: i

    call self%pi%destroy()
    call self%pi2%destroy()
    call self%pj%destroy()

    call self%IAPWS_region_type%destroy()

    do i = 1, self%num_subregions
       call self%subregion(i)%destroy()
    end do

  end subroutine region3_destroy

!------------------------------------------------------------------------

  subroutine region3_properties(self, param, props, err)
    !! Calculates pressure and internal energy of supercritical water/steam
    !! as a function of density and temperature (deg C).
    !!
    !! Returns err = 1 if resulting pressure is outside its operating range (p<=100 MPa).

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (density, temperature)
    PetscReal, intent(out):: props(:)  !! (pressure, internal energy)
    PetscInt, intent(out) :: err   !! Error code
    ! Locals:
    PetscReal:: tk, rt, delta, tau
    PetscReal:: phidelta, phitau

    associate (d => param(1), t => param(2))

      tk = t + tc_k
      rt = specific_gas_constant * tk
      tau = self%tstar / tk
      delta = d / self%dstar

      call self%pi%compute(delta)
      call self%pj%compute(tau)

      phidelta = self%n(1) * self%pi%power(-1) + &
           sum(self%nI * self%pi%power(self%I_1) * self%pj%power(self%J))
      phitau = sum(self%nJ * self%pi%power(self%I)   * self%pj%power(self%J_1))

      props(1) = d * rt * delta * phidelta ! pressure
      props(2) = rt * tau * phitau         ! internal energy
      if (props(1) > 100.0e6_dp) then
         err = 1
      else
         err = 0
      end if

    end associate

  end subroutine region3_properties

!------------------------------------------------------------------------

  PetscReal function region3_dpdd(self, param) result(dpdd)
    !! Calculates derivative of pressure with respect to density of
    !! supercritical water/steam as a function of density and
    !! temperature (deg C).

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (density, temperature)
    ! Locals:
    PetscReal:: tk, rt, delta, tau
    PetscReal:: phidelta, phidelta2

    associate (d => param(1), t => param(2))

      tk = t + tc_k
      rt = specific_gas_constant * tk
      tau = self%tstar / tk
      delta = d / self%dstar

      call self%pi2%compute(delta)
      call self%pj%compute(tau)

      phidelta = self%n(1) * self%pi2%power(-1) + &
           sum(self%nI * self%pi2%power(self%I_1) * self%pj%power(self%J))
      phidelta2 = -self%n(1) * self%pi2%power(-2) + &
           sum(self%nI * self%I_1 * self%pi2%power(self%I_2) * self%pj%power(self%J))

      dpdd = rt * (2._dp * delta * phidelta + self%pi2%power(2) * phidelta2)

    end associate

  end function region3_dpdd

!------------------------------------------------------------------------
! Region 3 subregion boundaries:
!------------------------------------------------------------------------

  PetscReal function region3_subregion_boundary_poly(self, n, p) result(tk)
    class(IAPWS_region3_type), intent(in) :: self
    PetscReal, intent(in) :: n(:)
    PetscReal, intent(in) :: p

    associate(pi => p / self%pstar)
      tk = polynomial(n, pi)
    end associate

  end function region3_subregion_boundary_poly

  PetscReal function region3_subregion_boundary_logpoly(self, n, ninv, p) &
       result(tk)
    !! For subregion boundaries ab and op.
    class(IAPWS_region3_type), intent(in) :: self
    PetscReal, intent(in) :: n(:), ninv(:)
    PetscReal, intent(in) :: p

    associate(lnpi => log(p / self%pstar))
      tk = polynomial(n, lnpi) + polynomial(ninv, 1._dp / lnpi)
    end associate

  end function region3_subregion_boundary_logpoly

  PetscReal function region3_subregion_boundary_3ef(self, p) result(tk)
    class(IAPWS_region3_type), intent(in) :: self
    PetscReal, intent(in) :: p
    ! Locals:
    PetscReal, parameter :: dtheta_dpi = 3.727888004_dp

    associate(pi => p / self%pstar)
      tk = dtheta_dpi * (pi - 22.064_dp) + 647.096_dp
    end associate

  end function region3_subregion_boundary_3ef

!------------------------------------------------------------------------

  PetscInt function region3_subregion_index(self, param) result(sr)
    !! Returns region 3 subregion index for given pressure and
    !! temperature (or -1 if the subregion could not be found).

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (pressure, temperature)
    ! Locals:
    PetscReal :: tsat, tsatk
    PetscErrorCode :: err

    sr = -1

    associate(p => param(1), tk => param(2) + tc_k)

      if (p > self%thermo%max_pressure) then
         continue
      else if (p > 40.e6_dp) then
         if (tk <= self%subregion_boundary_logpoly(self%subregion_bdy_n_ab, &
              self%subregion_bdy_ninv_ab, p)) then
            sr = 1 ! a
         else
            sr = 2 ! b
         end if
      else if (p > 25.e6_dp) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else if (tk <= self%subregion_boundary_logpoly(self%subregion_bdy_n_ab, &
              self%subregion_bdy_ninv_ab, p)) then
            sr = 4 ! d
         else if (tk <= self%subregion_boundary_3ef(p)) then
            sr = 5 ! e
         else
            sr = 6 ! f
         end if
      else if (p > 23.5e6_dp) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_gh, p)) then
            sr = 7 ! g
         else if (tk <= self%subregion_boundary_3ef(p)) then
            sr = 8 ! h
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_ij, p)) then
            sr = 9 ! i
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_jk, p)) then
            sr = 10 ! j
         else
            sr = 11 ! k
         end if
      else if (p > 23.e6_dp) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_gh, p)) then
            sr = 12 ! l
         else if (tk <= self%subregion_boundary_3ef(p)) then
            sr = 8 ! h
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_ij, p)) then
            sr = 9 ! i
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_jk, p)) then
            sr = 10 ! j
         else
            sr = 11 ! k
         end if
      else if (p > 22.5e6_dp) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_gh, p)) then
            sr = 12 ! l
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_mn, p)) then
            sr = 13 ! m
         else if (tk <= self%subregion_boundary_3ef(p)) then
            sr = 14 ! n
         else if (tk <= self%subregion_boundary_logpoly(self%subregion_bdy_n_op, &
              self%subregion_bdy_ninv_op, p)) then
            sr = 15 ! o
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_ij, p)) then
            sr = 16 ! p
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_jk, p)) then
            sr = 10 ! j
         else
            sr = 11 ! k
         end if
      else if (p > self%psat_643) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_qu, p)) then
            sr = 17 ! q
         else if ((tk > self%subregion_boundary_poly(self%subregion_bdy_n_rx, p)) &
              .and. (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_jk, p))) then
            sr = 18 ! r
         else if (tk > self%subregion_boundary_poly(self%subregion_bdy_n_jk, p)) then
            sr = 11 ! k
         else
            sr = self%auxiliary_subregion_index(param)
         end if
      else if (p > 20.5e6_dp) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else
            call self%thermo%saturation%temperature(p, tsat, err)
            tsatk = tsat + tc_k
            if (err == 0) then
               if (tk <= tsatk) then
                  sr = 19 ! s
               else if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_jk, p)) then
                  sr = 18 ! r
               else
                  sr = 11 ! k
               end if
            end if
         end if
      else if (p > self%p3cd) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_cd, p)) then
            sr = 3 ! c
         else
            call self%thermo%saturation%temperature(p, tsat, err)
            tsatk = tsat + tc_k
            if (err == 0) then
               if (tk <= tsatk) then
                  sr = 19 ! s
               else
                  sr = 20 ! t
               end if
            end if
         end if
      else if (p > self%psat_623) then
         call self%thermo%saturation%temperature(p, tsat, err)
         tsatk = tsat + tc_k
         if (err == 0) then
            if (tk <= tsatk) then
               sr = 3 ! c
            else
               sr = 20 ! t
            end if
         end if
      end if

    end associate

  end function region3_subregion_index

!------------------------------------------------------------------------

  PetscInt function region3_auxiliary_subregion_index(self, param) result(sr)
    !! Returns region 3 auxiliary subregion index for given pressure and
    !! temperature (or -1 if the subregion could not be found).

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (pressure, temperature)
    ! Locals:
    PetscReal :: tsat, tsatk
    PetscErrorCode :: err

    sr = -1

    associate(p => param(1), tk => param(2) + tc_k)

      if (p > 22.11e6_dp) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_uv, p)) then
            sr = 21 ! u
         else if (tk <= self%subregion_boundary_3ef(p)) then
            sr = 22 ! v
         else if (tk <= self%subregion_boundary_logpoly(self%subregion_bdy_n_wx, &
              self%subregion_bdy_ninv_wx, p)) then
            sr = 23 ! w
         else
            sr = 24 ! x
         end if
      else if (p > self%thermo%critical%pressure) then
         if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_uv, p)) then
            sr = 21 ! u
         else if (tk <= self%subregion_boundary_3ef(p)) then
            sr = 25 ! y
         else if (tk <= self%subregion_boundary_logpoly(self%subregion_bdy_n_wx, &
              self%subregion_bdy_ninv_wx, p)) then
            sr = 26 ! z
         else
            sr = 24 ! x
         end if
      else ! sub-critical:
         call self%thermo%saturation%temperature(p, tsat, err)
         tsatk = tsat + tc_k
         if (err == 0) then
            if (tk <= tsatk) then
               if (p > 2.193161551e7_dp) then
                  if (tk <= self%subregion_boundary_poly(self%subregion_bdy_n_uv, p)) then
                     sr = 21 ! u
                  else
                     sr = 25 ! y
                  end if
               else if (p > self%psat_643) then
                  sr = 21 ! u
               end if
            else
               if (p > 2.190096265e7_dp) then
                  if (tk <= self%subregion_boundary_logpoly(self%subregion_bdy_n_wx, &
                       self%subregion_bdy_ninv_wx, p)) then
                     sr = 26 ! z
                  else
                     sr = 24 ! x
                  end if
               else if (p > self%psat_643) then
                  sr = 24 ! x
               end if
            end if
         end if
      end if

    end associate

  end function region3_auxiliary_subregion_index

!------------------------------------------------------------------------

  subroutine region3_density(self, param, density, err, polish)
    !! Calculates density in region 3 as a function of pressure and
    !! temperature (deg C). The IAPWS backward and auxiliary equations
    !! for region 3 are used.  Returns err = 1 if the density cannot
    !! be found.

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: param(:) !! Primary variables (pressure, temperature)
    PetscReal, intent(out):: density  !! Fluid density
    PetscInt, intent(out) :: err   !! Error code
    PetscBool, intent(in) :: polish   !! Whether to polish result with Newton iteration
    ! Locals:
    PetscInt :: sr
    PetscReal :: nu
    PetscInt, parameter :: maxit = 8
    PetscReal, parameter :: ftol = 1.e-5_dp, xtol = 1.e-5_dp

    err = 0
    sr =  self%subregion_index(param)

    if (sr > 0) then
       nu = self%subregion(sr)%specific_volume(param)
       density = 1._dp / nu
       if (polish) then
          call newton1d(f, df, density, ftol, xtol, maxit, err)
       end if
    else
       err = 1
    end if

  contains

!........................................................................

    PetscReal function f(x, err)
      PetscReal, intent(in) :: x
      PetscErrorCode, intent(out) :: err
      ! Locals:
      PetscReal :: props(2)

      associate(density => x, pcalc => props(1), &
           p => param(1), t => param(2))
        call self%properties([density, t], props, err)
        f = pcalc - p
      end associate

    end function f

!........................................................................

    PetscReal function df(x, err)
      PetscReal, intent(in) :: x
      PetscErrorCode, intent(out) :: err

      err = 0
      associate(density => x, t => param(2))
        df = self%dpdd([density, t])
      end associate

    end function df

  end subroutine region3_density

!------------------------------------------------------------------------

  subroutine region3_widom(self, pressure, temperature, err)
    !! Returns Widom line temperature as a function of pressure. This
    !! is the inverse of the exponential Widom function of Banuti et
    !! al. (2017) - not actually part of the IAPWS formulation.

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: pressure
    PetscReal, intent(out) :: temperature
    PetscErrorCode, intent(out) :: err

    if (pressure >= self%widom_delta_zero_pressure) then
       temperature = self%thermo%critical%temperature_k * (1._dp + &
            log(pressure / self%thermo%critical%pressure) / self%widom_slope) &
            - tc_k
       err = 0
    else
       err = 1
    end if

  end subroutine region3_widom

!------------------------------------------------------------------------

  subroutine region3_widom_delta(self, pressure, delta, err)
    !! Returns Widom delta minimum and maximum temperatures as a
    !! function of pressure. These are the temperatures at which the
    !! number fractions of liquid-like particles are 1 and 0
    !! respectively. The centre of the Widom delta follows the Widom
    !! line, and its width is assumed to grow linearly with pressure,
    !! starting from a small finite width at the critical point (for
    !! numerical purposes).

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: pressure
    PetscReal, intent(out) :: delta(2)
    PetscErrorCode, intent(out) :: err
    ! Locals:
    PetscReal :: Tw, dT

    if (pressure >= self%widom_delta_zero_pressure) then
       call self%widom(pressure, Tw, err)
       if (err == 0) then
          dT = self%widom_delta_growth * &
               ((pressure + self%widom_delta_min_pressure) / &
               self%thermo%critical%pressure - 1._dp)
          delta = [Tw - 0.5_dp * dT, Tw + 0.5_dp * dT]
       end if
    else
       err = 1
    end if

  end subroutine region3_widom_delta

!------------------------------------------------------------------------

  subroutine region3_pi_liquidlike(self, pressure, temperature, density, &
       pi_liq, err)
    !! Returns number fraction of liquid-like fluid particles as a
    !! function of pressure and temperature. For supercritical fluid
    !! this is assumed to vary smoothly from 1 to 0 through the Widom
    !! delta according to a cubic Hermite polynomial with zero slope
    !! at both ends. For sub-critical fluid (T < Tc and P < Pc), the
    !! result is determined by the given density.

    class(IAPWS_region3_type), intent(in out) :: self
    PetscReal, intent(in) :: pressure, temperature, density
    PetscReal, intent(out) :: pi_liq
    PetscErrorCode, intent(out) :: err
    ! Locals:
    PetscReal :: delta(2), xi

    err = 0

    if (pressure >= self%widom_delta_zero_pressure) then
       if (temperature >= self%widom_delta_zero_temperature) then
          call self%widom_delta(pressure, delta, err)
          if (err == 0) then
             xi = (temperature - delta(1)) / (delta(2) - delta(1))
             pi_liq = hermite(xi)
          end if
       else
          pi_liq = 1._dp
       end if
    else
       if (temperature >= self%widom_delta_zero_temperature) then
          pi_liq = 0._dp
       else
          if (density >= self%thermo%critical%density) then
             pi_liq = 1._dp
          else
             pi_liq = 0._dp
          end if
       end if
    end if

  contains

    PetscReal function hermite(xi)

      PetscReal, intent(in) :: xi

      if (xi < 0._dp) then
         hermite = 1._dp
      else if (xi > 1._dp) then
         hermite = 0._dp
      else
         hermite =  xi * xi * (2._dp * xi - 3._dp) + 1._dp
      end if

    end function hermite

  end subroutine region3_pi_liquidlike

!------------------------------------------------------------------------
! Viscosity
!------------------------------------------------------------------------

  subroutine viscosity_init(self)
    !! Initializes viscosity object.

    class(IAPWS_viscosity_type), intent(in out) :: self

    ! Configure power tables:
    call self%pi%configure(self%I)
    call self%pj%configure(self%J)
    call self%pk%configure(self%k)

  end subroutine viscosity_init

!------------------------------------------------------------------------

  subroutine viscosity_destroy(self)
    !! Destroys viscosity object.

    class(IAPWS_viscosity_type), intent(in out) :: self

    call self%pi%destroy()
    call self%pj%destroy()
    call self%pk%destroy()

  end subroutine viscosity_destroy

!------------------------------------------------------------------------
! Saturation curve
!------------------------------------------------------------------------

  subroutine saturation_pressure(self, t, p, err)
    !! Calculates saturation pressure as a function of temperature.
    !! Returns err = 1 if called outside its operating range (0 <= t <= critical temperature).

    class(IAPWS_saturation_type), intent(in) :: self
    PetscReal, intent(in) :: t  !! Fluid temperature (\(^\circ C\))
    PetscReal, intent(out):: p  !! Fluid pressure (\(kg. m. s^{-1}\))
    PetscInt, intent(out) :: err  !! Error code
    ! Locals:
    PetscReal:: tk
    PetscReal:: theta, theta2, a, b, c, x

    if ((t >= 0._dp).and.(t <= self%thermo%critical%temperature)) then
       tk = t + tc_k      
       theta = tk + self%n(9) / (tk - self%n(10))
       theta2 = theta * theta
       a = theta2 + self%n(1) * theta + self%n(2)
       b = self%n(3) * theta2 + self%n(4) * theta + self%n(5)
       c = self%n(6) * theta2 + self%n(7) * theta + self%n(8)
       x = 2._dp * c / (-b + dsqrt(b*b - 4._dp*a*c))
       x = x * x
       p = self%pstar * x * x
       err = 0
    else
       err = 1
    end if

  end subroutine saturation_pressure

!------------------------------------------------------------------------

  subroutine saturation_temperature(self, p, t, err)
    !! Calculates saturation temperature (deg C) as a function of pressure.
    !! Returns err = 1 if called outside its operating range (611.213 Pa <= p <= critical pressure).

    class(IAPWS_saturation_type), intent(in) :: self
    PetscReal, intent(in) :: p  !! Fluid pressure (\(kg. m. s^{-1}\))
    PetscReal, intent(out):: t  !! Fluid temperature (\(^\circ C\))
    PetscInt, intent(out) :: err !! Error code
    ! Locals:
    PetscReal:: beta, beta2, d, e, f, g, x

    if ((p >= 611.213_dp).and.(p <= self%thermo%critical%pressure)) then
       beta2 = dsqrt(p / self%pstar)
       beta = dsqrt(beta2)
       e = beta2 + self%n(3) * beta + self%n(6)
       f = self%n(1) * beta2 + self%n(4) * beta + self%n(7)
       g = self%n(2) * beta2 + self%n(5) * beta + self%n(8)
       d = 2.0_dp * g / (-f - dsqrt(f*f - 4._dp*e*g))
       x = self%n(10) + d
       t = 0.5_dp * (self%n(10) + d - dsqrt(x*x - 4._dp * (self%n(9) + self%n(10) * d))) - tc_k
       err = 0
    else
       err = 1
    end if

  end subroutine saturation_temperature

!------------------------------------------------------------------------
! Region 2/3 boundary
!------------------------------------------------------------------------

  subroutine boundary23_pressure(self, t, p)
    !! Calculates the pressure p (Pa) on the boundary between regions 2 and 3,
    !! given a temperature t (deg C).

    class(IAPWS_boundary23_type), intent(in) :: self
    PetscReal, intent(in) :: t  !! Fluid temperature (\(^\circ C\))
    PetscReal, intent(out):: p  !! Fluid pressure (\(kg. m. s^{-1}\))
    ! Local variable:      
    PetscReal:: tk

    tk = t + tc_k
    p  = self%pstar * (self%n(1) + tk * (self%n(2) + tk * self%n(3))) 

  end subroutine boundary23_pressure

!-----------------------------------------------------------------------

  subroutine boundary23_temperature(self, p, t)
    !! Calculates the temperature t (deg C) on the boundary between regions 2 and 3,
    !! given a pressure p (Pa).

    class(IAPWS_boundary23_type), intent(in) :: self
    PetscReal, intent(in) :: p  !! Fluid pressure (\(kg. m. s^{-1}\))
    PetscReal, intent(out):: t  !! Fluid temperature (\(^\circ C\))

    t = self%n(4) + dsqrt((p/self%pstar - self%n(5)) / self%n(3)) - tc_k 

  end subroutine boundary23_temperature

!------------------------------------------------------------------------
! Region 3/4 boundary
!------------------------------------------------------------------------

  subroutine boundary34_init(self, thermo)
    !! Initialise boundary34 type.

    class(IAPWS_boundary34_type), intent(in out) :: self
    type(IAPWS_type), target, intent(in) :: thermo

    self%thermo => thermo

  end subroutine boundary34_init

!------------------------------------------------------------------------

  subroutine boundary34_temperature(self, density, t, err)
    !! Calculates an approximate temperature t (deg C) on the boundary
    !! between regions 3 and 4, given a density (kg/m3). The
    !! temperature is calculated from a pair of degree 6 polynomials,
    !! one below and one above the critical point, both with zero
    !! slope at the critical point itself. Returns a non-zero error
    !! code if called outside its operating density range.

    class(IAPWS_boundary34_type), intent(in) :: self
    PetscReal, intent(in) :: density !! Fluid pressure (\(kg. m^{3}\))
    PetscReal, intent(out):: t  !! Fluid temperature (\(^\circ C\))
    PetscErrorCode, intent(out) :: err !! Error code
    ! Locals:
    PetscReal :: r, tau

    err = 0

    if ((self%thermo%max_vapour_density_bdy_1_3 <= density) .and. &
         (density <= self%thermo%min_liquid_density_bdy_1_3)) then

       if (density >= self%thermo%critical%density) then
          r = density / self%thermo%critical%density - 1._dp
          tau = r * r * polynomial(self%nl, r)
       else
          r = 1._dp - density / self%thermo%critical%density
          tau = r * r * polynomial(self%nv, r)
       end if

       t = self%thermo%critical%temperature * (1._dp - tau)

    else
       err = 1
    end if

  end subroutine boundary34_temperature

!------------------------------------------------------------------------

end module IAPWS_module
